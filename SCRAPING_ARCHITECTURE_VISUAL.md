# 🏗️ ВИЗУАЛЬНАЯ СХЕМА АРХИТЕКТУРЫ СИСТЕМЫ СКРАПИНГА

## 🔄 Общая схема потока данных

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ВХОДНАЯ ТОЧКА                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   [URL товара] ──► /api/catalog/products/parse-and-import          │
│                                                                      │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    🎯 UrlParserService                              │
│                      (Главный оркестратор)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   1. detectMarketplace(url)                                         │
│   2. Выбор стратегии парсинга                                      │
│   3. Управление fallback механизмом                                 │
│                                                                      │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────┴──────────────────┐
        │                                      │
        ▼                                      ▼
┌──────────────────┐                  ┌──────────────────┐
│  ЗАЩИЩЕННЫЕ      │                  │  ОБЫЧНЫЕ САЙТЫ  │
│  МАРКЕТПЛЕЙСЫ    │                  │                  │
└────────┬─────────┘                  └────────┬─────────┘
         │                                      │
         ▼                                      ▼
```

## 🔐 Парсинг защищенных маркетплейсов

```
ЗАЩИЩЕННЫЕ МАРКЕТПЛЕЙСЫ
(Wildberries, Ozon, AliExpress, Яндекс.Маркет)
         │
         ▼
┌─────────────────────────────────┐
│  🎭 PlaywrightParserService     │ ◄── УРОВЕНЬ 1
│   • Playwright + Stealth        │
│   • Anti-bot обход              │
│   • Accessibility tree          │
│   • Валидация изображений       │
└─────────────┬───────────────────┘
              │ FAIL
              ▼
┌─────────────────────────────────┐
│  🌐 BrowserParserService        │ ◄── УРОВЕНЬ 2
│   • Puppeteer fallback          │
│   • Базовый browser automation  │
└─────────────┬───────────────────┘
              │ FAIL
              ▼
┌─────────────────────────────────┐
│  ☁️ ScraperApiService           │ ◄── УРОВЕНЬ 3
│   • Облачный парсинг            │
│   • Premium прокси              │
│   • $0.012 за запрос            │
└─────────────┬───────────────────┘
              │ FAIL
              ▼
┌─────────────────────────────────┐
│  ❌ Ошибка парсинга             │ ◄── УРОВЕНЬ 4
│   "Не удалось распарсить"       │
└─────────────────────────────────┘
```

## 🌐 Парсинг обычных сайтов

```
ОБЫЧНЫЕ САЙТЫ
         │
         ▼
┌─────────────────────────────────┐
│  📖 OpenGraph парсинг           │ ◄── УРОВЕНЬ 1
│   • og:title, og:image          │
│   • twitter:card метатеги       │
└─────────────┬───────────────────┘
              │ FAIL
              ▼
┌─────────────────────────────────┐
│  🔍 HTML парсинг (Cheerio)      │ ◄── УРОВЕНЬ 2
│   • Прямой анализ DOM           │
│   • Поиск структурных данных    │
└─────────────┬───────────────────┘
              │ FAIL
              ▼
┌─────────────────────────────────┐
│  🌐 BrowserParserService        │ ◄── УРОВЕНЬ 3
│   • Puppeteer для JS сайтов     │
└─────────────────────────────────┘
```

## 💾 Процесс сохранения данных

```
         ПАРСИРОВАННЫЕ ДАННЫЕ
                  │
                  ▼
┌─────────────────────────────────┐
│    ОБРАБОТКА ИЗОБРАЖЕНИЙ        │
├─────────────────────────────────┤
│ 1. Валидация размера (400x400)  │
│ 2. Скачивание изображения       │
│ 3. Транслитерация имени файла   │
│ 4. Загрузка в Supabase Storage  │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│    ПОДГОТОВКА ДАННЫХ            │
├─────────────────────────────────┤
│ • Парсинг цены                  │
│ • Определение категории         │
│ • Создание specifications JSON  │
│ • Поиск/создание поставщика     │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│      SUPABASE DATABASE          │
├─────────────────────────────────┤
│  catalog_verified_products      │
│  ├── id (UUID)                  │
│  ├── name                       │
│  ├── description                │
│  ├── category                   │
│  ├── price                      │
│  ├── images[] (Storage URLs)    │
│  └── specifications (JSON)      │
└─────────────────────────────────┘
```

## 📊 Статистика использования парсеров

```
┌──────────────────────────────────────────┐
│           РАСПРЕДЕЛЕНИЕ НАГРУЗКИ         │
├──────────────────────────────────────────┤
│                                          │
│  PlaywrightParser    ████████████  60%  │
│  ScraperAPI          ██████       30%   │
│  OpenGraph/HTML      ███          8%    │
│  BrowserParser       █            2%    │
│                                          │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│         УСПЕШНОСТЬ ПАРСИНГА              │
├──────────────────────────────────────────┤
│                                          │
│  Яндекс.Маркет      ████████████  98%   │
│  Обычные сайты      ███████████   95%   │
│  Wildberries        █████████     90%   │
│  Ozon               ████████      85%   │
│  AliExpress         ███████       80%   │
│                                          │
└──────────────────────────────────────────┘
```

## 🔧 Конфигурация сервисов

```yaml
PlaywrightParserService:
  browser: Chromium
  headless: true
  timeout: 30s
  anti_bot:
    - Random User-Agent
    - Random Viewport
    - Stealth plugin
    - WebDriver override

ScraperApiService:
  api_key: SCRAPER_API_KEY
  render: true
  country: ru
  premium: true (Ozon, WB)
  cost: $0.012/request

Storage:
  bucket: product-images
  path: imported/{timestamp}_{name}.{ext}
  cache: 3600s
  public: true
```

## 🚀 Команды для тестирования

```bash
# Единичный импорт
curl -X POST http://localhost:3000/api/catalog/products/parse-and-import \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://market.yandex.ru/product/123",
    "category": "ТЕСТОВАЯ"
  }'

# Batch импорт (30 товаров)
SCRAPER_API_KEY="your_key" node scripts/batch-import-30-products.js

# Проверка изображений
node scripts/check-storage-images.js

# Тест ScraperAPI
node scripts/test-scraper-api.js
```

## 📈 Метрики производительности

```
┌────────────────────────────────────────────────┐
│              ВРЕМЯ ПАРСИНГА                    │
├────────────────────────────────────────────────┤
│                                                │
│  PlaywrightParser:                            │
│  ├── Инициализация   ████          2-3 сек    │
│  ├── Загрузка        ██████        3-4 сек    │
│  └── Парсинг         ██            1 сек      │
│                                                │
│  ScraperAPI:                                  │
│  ├── API запрос      ████████      5-6 сек    │
│  └── Обработка       ██            1-2 сек    │
│                                                │
│  OpenGraph:                                   │
│  └── HTTP запрос     ██            0.5-1 сек  │
│                                                │
└────────────────────────────────────────────────┘
```

---

*Визуальная схема архитектуры системы скрапинга и парсинга товаров*