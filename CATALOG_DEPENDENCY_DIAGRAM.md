# CATALOG PAGE - ДИАГРАММА ЗАВИСИМОСТЕЙ И РИСКОВ

## ВИЗУАЛЬНАЯ КАРТА КОМПОНЕНТА

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         CATALOG PAGE.TSX                                │
│                      5436 СТРОК | 293.6 KB                              │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    БЛОК 1: СОСТОЯНИЯ (53 useState)             │    │
│  │─────────────────────────────────────────────────────────────────│    │
│  │                                                                  │    │
│  │  🟢 ГРУППА 1: Безопасные (изолированные)                       │    │
│  │  ├─ searchQuery                         [риск: 0%]            │    │
│  │  ├─ currentPage                          [риск: 0%]            │    │
│  │  ├─ quantity                             [риск: 0%]            │    │
│  │  └─ selectedProduct                      [риск: 0%]            │    │
│  │                                                                  │    │
│  │  🟡 ГРУППА 2: Навигация (связанные)                           │    │
│  │  ├─ catalogMode ──────┬──── selectedRoom  [риск: 20%]         │    │
│  │  ├─ selectedCategoryData ─┼─ selectedSubcategoryData          │    │
│  │  └─ activeMode ───────┘                   [риск: 20%]         │    │
│  │                                                                  │    │
│  │  🟡 ГРУППА 3: Данные (API-зависимые)                          │    │
│  │  ├─ realSuppliers ────┬──── loadingSuppliers                  │    │
│  │  ├─ verifiedSuppliers ─┼─── loadingVerified  [риск: 15%]     │    │
│  │  ├─ apiCategories ─────┼─── loadingCategories                 │    │
│  │  ├─ echoCards ─────────┼─── loadingEchoCards                  │    │
│  │  └─ recommendations ───┴─── loadingRecommendations            │    │
│  │                                                                  │    │
│  │  🟡 ГРУППА 4: Корзина (localStorage)                          │    │
│  │  ├─ cart ─────────────┬──── cartLoaded                        │    │
│  │  └─ activeSupplier ───┘     [риск: 10%]                       │    │
│  │                                                                  │    │
│  │  🔴 ГРУППА 5: ФОРМА ПОСТАВЩИКА (ОПАСНО!)                      │    │
│  │  ├─ supplierFormData ───┬──── supplierFormStep                │    │
│  │  ├─ maxSupplierStep ─────┼──── supplierFormErrors             │    │
│  │  ├─ uploadingImages ─────┼──── echoCardForImport              │    │
│  │  ├─ editingSupplier ─────┼──── showAddSupplierModal           │    │
│  │  └─ loading ─────────────┘     [риск: 50%]                    │    │
│  │                                                                  │    │
│  │  🟡 ГРУППА 6: Модальные окна                                  │    │
│  │  ├─ showEchoCardsModal                                         │    │
│  │  ├─ showCart                                                   │    │
│  │  ├─ showProductModal                                           │    │
│  │  └─ showProductEditor                    [риск: 10%]          │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │              БЛОК 2: API ФУНКЦИИ (17 fetch вызовов)           │    │
│  │─────────────────────────────────────────────────────────────────│    │
│  │                                                                  │    │
│  │  🟢 loadVerifiedSuppliersFromAPI()    [риск: 5%]              │    │
│  │  🟡 loadSuppliersFromAPI()            [риск: 10%]             │    │
│  │  🟡 loadCategoriesFromAPI()           [риск: 10%]             │    │
│  │  🟡 loadSupplierProducts()            [риск: 10%]             │    │
│  │  🟡 loadRecommendations()             [риск: 15%]             │    │
│  │  🟡 loadEchoCards()                   [риск: 15%]             │    │
│  │  🔴 importSupplierFromEchoCard()      [риск: 30%]             │    │
│  │  🔴 handleSubmitSupplier()            [риск: 90%]             │    │
│  │  🔴 handleAddSupplierToPersonal()     [риск: 95%]             │    │
│  │                                                                  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │              БЛОК 3: useEffect HOOKS (10 штук)                 │    │
│  │─────────────────────────────────────────────────────────────────│    │
│  │                                                                  │    │
│  │  🟢 useEffect: Supabase connection check      [риск: 5%]       │    │
│  │  🟡 useEffect: Load suppliers on mount        [риск: 10%]      │    │
│  │  🟡 useEffect: Initialize auth token          [риск: 10%]      │    │
│  │  🟡 useEffect: Load recommendations           [риск: 15%]      │    │
│  │  🟡 useEffect: Cart localStorage load         [риск: 10%]      │    │
│  │  🟡 useEffect: Cart localStorage save         [риск: 10%]      │    │
│  │  🟡 useEffect: Active supplier save           [риск: 5%]       │    │
│  │  🔴 useEffect: URL params handling            [риск: 60%] ⚠️   │    │
│  │  🔴 useEffect: Echo card prefill              [риск: 50%] ⚠️   │    │
│  │                                                                  │    │
│  │  ⚠️  КРИТИЧНО: setInterval + setTimeout внутри!               │    │
│  │                                                                  │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    БЛОК 4: JSX (3000+ строк)                   │    │
│  │─────────────────────────────────────────────────────────────────│    │
│  │                                                                  │    │
│  │  • Header с навигацией                                          │    │
│  │  • Режим "по поставщикам" (inline карточки)                    │    │
│  │  • Режим "по категориям" (inline компоненты)                   │    │
│  │  • 4+ модальных окна (inline JSX)                              │    │
│  │  • Форма поставщика (7 шагов, inline)                          │    │
│  │                                                                  │    │
│  └────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## ДИАГРАММА ЗАВИСИМОСТЕЙ СОСТОЯНИЙ

```
                    ┌──────────────────────┐
                    │   catalogMode        │
                    │  (suppliers | cat)   │
                    └──────────┬───────────┘
                               │
                    ┌──────────▼───────────┐
                    │   selectedRoom       │
                    │   (orange | blue)    │
                    └──────────┬───────────┘
                               │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
    ┌─────────────────┐ ┌──────────────┐ ┌─────────────┐
    │ selectedCategory│ │ realSuppliers│ │ verifiedSupp│
    │      Data       │ │              │ │    liers    │
    └─────────┬───────┘ └──────────────┘ └─────────────┘
              │
              ▼
    ┌─────────────────┐
    │selectedSubcatego│
    │     ryData      │
    └─────────────────┘


    ┌──────────────────────────────────────────────────┐
    │         ФОРМА ПОСТАВЩИКА (6 состояний)           │
    │──────────────────────────────────────────────────│
    │                                                   │
    │  supplierFormData (30+ полей)                   │
    │         │                                         │
    │         ├──► supplierFormStep (1-7)              │
    │         │                                         │
    │         ├──► maxSupplierStep (1-7)               │
    │         │                                         │
    │         ├──► supplierFormErrors {}                │
    │         │                                         │
    │         ├──► uploadingImages {}                   │
    │         │                                         │
    │         └──► echoCardForImport                    │
    │                                                   │
    │  ⚠️  ВСЕ СВЯЗАНЫ! Нельзя вынести по отдельности │
    └──────────────────────────────────────────────────┘


    ┌──────────────────────────────────────────────────┐
    │           КОРЗИНА (3 состояния)                  │
    │──────────────────────────────────────────────────│
    │                                                   │
    │  cart: CartItem[]                                │
    │    │                                              │
    │    ├──► activeSupplier: string | null            │
    │    │                                              │
    │    └──► cartLoaded: boolean                      │
    │                                                   │
    │  ✅ Можно вынести в hook useCart()               │
    └──────────────────────────────────────────────────┘
```

---

## КАРТА РИСКОВ

```
┌───────────────────────────────────────────────────────────┐
│                    ШКАЛА РИСКОВ                           │
├───────────────────────────────────────────────────────────┤
│                                                            │
│  🟢 0-10%   │ Безопасно, можно делать прямо сейчас       │
│  🟡 10-30%  │ Низкий риск, требует осторожности          │
│  🟠 30-50%  │ Средний риск, нужна подготовка             │
│  🔴 50-70%  │ Высокий риск, ОПАСНО без плана             │
│  ⛔ 70-100% │ КРИТИЧНО, НЕ ТРОГАТЬ без экспертизы       │
│                                                            │
└───────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────┐
│                  МОДУЛИ ПО УРОВНЯМ РИСКА                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🟢 УРОВЕНЬ 1: Безопасно (0-10%)                            │
│  ├─ types/catalog.types.ts                      [риск: 0%] │
│  ├─ constants/catalog.constants.ts              [риск: 0%] │
│  ├─ utils/catalog.utils.ts                      [риск: 0%] │
│  └─ components/SupplierCard.tsx (exists)        [риск: 5%] │
│                                                              │
│  🟡 УРОВЕНЬ 2: Низкий риск (10-30%)                         │
│  ├─ services/supplierService.ts                [риск: 15%] │
│  ├─ services/categoryService.ts                [риск: 10%] │
│  ├─ services/productService.ts                 [риск: 10%] │
│  ├─ hooks/useCart.ts                           [риск: 10%] │
│  ├─ hooks/useSuppliers.ts                      [риск: 15%] │
│  ├─ hooks/useCategories.ts                     [риск: 10%] │
│  └─ components/modals/CartModal.tsx            [риск: 30%] │
│                                                              │
│  🟠 УРОВЕНЬ 3: Средний риск (30-50%)                        │
│  ├─ components/modals/EchoCardsModal.tsx       [риск: 35%] │
│  ├─ components/modals/ProductModal.tsx         [риск: 30%] │
│  ├─ utils/supplierFormValidation.ts            [риск: 40%] │
│  └─ services/echoCardService.ts                [риск: 30%] │
│                                                              │
│  🔴 УРОВЕНЬ 4: Высокий риск (50-70%)                        │
│  ├─ context/SupplierFormContext.tsx            [риск: 50%] │
│  ├─ hooks/useURLParams.ts                      [риск: 60%] │
│  └─ useEffect: Echo card prefill               [риск: 50%] │
│                                                              │
│  ⛔ УРОВЕНЬ 5: КРИТИЧНО (70-100%)                           │
│  ├─ handleSubmitSupplier() migration          [риск: 90%] │
│  ├─ handleAddSupplierToPersonal() migration   [риск: 95%] │
│  └─ URL params useEffect refactor             [риск: 60%] │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## ГРАФ ЗАВИСИМОСТЕЙ ФУНКЦИЙ

```
                           ┌──────────────────┐
                           │   CatalogPage()  │
                           │   (main render)  │
                           └────────┬─────────┘
                                    │
                ┌───────────────────┼───────────────────┐
                │                   │                   │
                ▼                   ▼                   ▼
    ┌───────────────────┐ ┌─────────────────┐ ┌──────────────┐
    │ loadSuppliersFrom │ │ loadCategories  │ │  loadEcho    │
    │      API()        │ │    FromAPI()    │ │   Cards()    │
    └─────────┬─────────┘ └─────────┬───────┘ └──────┬───────┘
              │                     │                 │
              │                     │                 │
              ▼                     ▼                 ▼
    ┌───────────────────┐ ┌─────────────────┐ ┌──────────────┐
    │ setRealSuppliers  │ │setApiCategories │ │ setEchoCards │
    │ setVerifiedSuppl  │ │                 │ │              │
    └───────────────────┘ └─────────────────┘ └──────────────┘


    ┌──────────────────────────────────────────────────────┐
    │        КРИТИЧЕСКАЯ ФУНКЦИЯ: handleSubmitSupplier()   │
    │──────────────────────────────────────────────────────│
    │                                                       │
    │  ЗАВИСИМОСТИ (9 штук):                              │
    │  ├─ supplierFormData        (30+ полей)             │
    │  ├─ echoCardForImport       (статистика)            │
    │  ├─ setLoading()            (UI state)              │
    │  ├─ supabase.auth           (session)               │
    │  ├─ fetch('/api/...')       (network)               │
    │  ├─ loadSuppliersFromAPI()  (reload data)           │
    │  ├─ resetSupplierForm()     (reset state)           │
    │  ├─ setShowAddSupplierModal (close modal)           │
    │  └─ alert()                 (UI feedback)           │
    │                                                       │
    │  ПОБОЧНЫЕ ЭФФЕКТЫ (7 штук):                         │
    │  • Создает поставщика в БД                          │
    │  • Создает товары в цикле                           │
    │  • Перезагружает список поставщиков                 │
    │  • Закрывает модальное окно                         │
    │  • Сбрасывает форму                                 │
    │  • Показывает alert                                 │
    │  • Логирует в консоль (30+ console.log)             │
    │                                                       │
    │  ⛔ РИСК: 90% - НЕЛЬЗЯ ВЫНОСИТЬ БЕЗ ТЕСТОВ          │
    └──────────────────────────────────────────────────────┘


    ┌──────────────────────────────────────────────────────┐
    │    КРИТИЧЕСКИЙ useEffect: URL параметры (race!)      │
    │──────────────────────────────────────────────────────│
    │                                                       │
    │  useEffect(() => {                                   │
    │    const params = new URLSearchParams(...)           │
    │                                                       │
    │    const interval = setInterval(() => {    ⚠️        │
    │      if (apiCategories.length > 0) {                 │
    │        // async операции                             │
    │        fetch(subcategories)                          │
    │        setSelectedCategoryData()                     │
    │        setSelectedSubcategoryData()                  │
    │      }                                                │
    │    }, 100)  // каждые 100мс!                         │
    │                                                       │
    │    setTimeout(() => clearInterval(...), 5000)        │
    │  }, [apiCategories])                                 │
    │                                                       │
    │  ПРОБЛЕМЫ:                                           │
    │  • setInterval вместо условной проверки              │
    │  • Race condition если категории не загрузились      │
    │  • Множественные setState в async коде               │
    │  • Нет cleanup для interval                          │
    │                                                       │
    │  🔴 РИСК: 60% - МОЖЕТ СЛОМАТЬ НАВИГАЦИЮ              │
    └──────────────────────────────────────────────────────┘
```

---

## ПОРЯДОК ДЕКОМПОЗИЦИИ (БЕЗОПАСНЫЙ ПУТЬ)

```
ФАЗА 1: ТИПЫ И КОНСТАНТЫ (30 минут, 0% риск)
┌────────────────────────────────────────────┐
│ ✅ types/catalog.types.ts                 │
│ ✅ constants/catalog.constants.ts         │
│ ✅ utils/catalog.utils.ts                 │
└────────────────────────────────────────────┘
         │
         ├─► Обновить импорты в page.tsx
         └─► npm run build (проверка)


ФАЗА 2: СЕРВИСЫ API (2 часа, 15% риск)
┌────────────────────────────────────────────┐
│ ⚠️  services/supplierService.ts           │
│ ⚠️  services/categoryService.ts           │
│ ⚠️  services/productService.ts            │
│ ⚠️  services/echoCardService.ts           │
└────────────────────────────────────────────┘
         │
         ├─► Переписать вызовы fetch в page.tsx
         ├─► Тестировать каждый сервис
         └─► npm run dev (проверка)


ФАЗА 3: ХУКИ (3 часа, 20% риск)
┌────────────────────────────────────────────┐
│ ⚠️  hooks/useCart.ts                      │
│ ⚠️  hooks/useSuppliers.ts                 │
│ ⚠️  hooks/useCategories.ts                │
└────────────────────────────────────────────┘
         │
         ├─► Изолировать useState в хуки
         ├─► Тестировать каждый хук
         └─► Проверить localStorage sync


ФАЗА 4: МОДАЛЬНЫЕ ОКНА (4 часа, 30% риск)
┌────────────────────────────────────────────┐
│ 🟠 components/modals/EchoCardsModal.tsx   │
│ 🟠 components/modals/CartModal.tsx        │
│ 🟠 components/modals/ProductModal.tsx     │
└────────────────────────────────────────────┘
         │
         ├─► Вынести большие блоки JSX
         ├─► Тестировать открытие/закрытие
         └─► Проверить все действия


⛔ НЕ ТРОГАТЬ (оставить в page.tsx):
┌────────────────────────────────────────────┐
│ 🔴 Форма поставщика (6 состояний)        │
│ 🔴 useEffect URL параметры (setInterval)  │
│ 🔴 useEffect Echo card prefill (140 строк)│
│ 🔴 handleSubmitSupplier (200+ строк)      │
│ 🔴 handleAddSupplierToPersonal (100 строк)│
└────────────────────────────────────────────┘
```

---

## ТЕПЛОВАЯ КАРТА СЛОЖНОСТИ

```
ФАЙЛ page.tsx (5436 строк) - РАЗБИТ ПО ЗОНАМ:

Строки    │ Блок                         │ Сложность │ Риск выноса
──────────┼──────────────────────────────┼───────────┼─────────────
1-100     │ Импорты, инициализация       │ 🟢 Низкая │ 0%
100-500   │ useState хуки (53 шт)        │ 🔴 ВЫСОКАЯ│ 40%
500-850   │ useEffect хуки (9 шт)        │ 🟡 Средняя│ 25%
850-1000  │ useEffect Echo prefill       │ 🔴 КРИТИЧ │ 50% ⚠️
1000-1400 │ Вспомогательные функции      │ 🟡 Средняя│ 20%
1400-1800 │ Функции корзины              │ 🟢 Низкая │ 10%
1800-2000 │ Константы и категории        │ 🟢 Низкая │ 0%
2000-2500 │ JSX: Header и навигация      │ 🟡 Средняя│ 15%
2500-3500 │ JSX: Режим поставщиков       │ 🟡 Средняя│ 20%
3500-4500 │ JSX: Форма поставщика        │ 🔴 ВЫСОКАЯ│ 50% ⚠️
4500-5300 │ JSX: Модальные окна          │ 🟡 Средняя│ 30%
5300-5436 │ JSX: Корзина                 │ 🟢 Низкая │ 10%


ЛЕГЕНДА:
🟢 Низкая сложность   - можно выносить сразу
🟡 Средняя сложность  - требует подготовки
🟠 Высокая сложность  - нужен план
🔴 КРИТИЧЕСКАЯ        - ОПАСНО! Тесты обязательны
⚠️  Есть setInterval/setTimeout/race conditions
```

---

## ВЗАИМОДЕЙСТВИЕ МОДУЛЕЙ (ПОСЛЕ ДЕКОМПОЗИЦИИ)

```
┌─────────────────────────────────────────────────────────────┐
│                        page.tsx                             │
│                    (координатор, ~400 строк)                │
└────────┬──────────────┬──────────────┬──────────────────────┘
         │              │              │
         ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   useCart    │ │ useSuppliers │ │ useCategories│
│   hook       │ │   hook       │ │    hook      │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │
       ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Cart       │ │  Supplier    │ │  Category    │
│  Service     │ │  Service     │ │  Service     │
└──────────────┘ └──────────────┘ └──────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        ▼
                ┌──────────────┐
                │   Supabase   │
                │   Client     │
                └──────────────┘


┌─────────────────────────────────────────────────────────────┐
│                    МОДАЛЬНЫЕ ОКНА                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  page.tsx                                                   │
│     │                                                        │
│     ├──► <CartModal />          ─► useCart()                │
│     │                                                        │
│     ├──► <EchoCardsModal />     ─► EchoCardService         │
│     │                                                        │
│     └──► <AddSupplierModal />   ─► SupplierFormContext     │
│                                     (НЕ ВЫНЕСЕНО!)          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## КОНТРОЛЬНЫЕ ТОЧКИ ТЕСТИРОВАНИЯ

```
ПОСЛЕ ФАЗЫ 1 (Типы, константы, утилиты):
├─ [ ] npm run build проходит без ошибок
├─ [ ] Страница загружается
└─ [ ] Никаких визуальных изменений


ПОСЛЕ ФАЗЫ 2 (Сервисы API):
├─ [ ] Поставщики загружаются (синяя комната)
├─ [ ] Verified поставщики загружаются (оранжевая)
├─ [ ] Категории загружаются
├─ [ ] Поиск работает
└─ [ ] Фильтры работают


ПОСЛЕ ФАЗЫ 3 (Хуки):
├─ [ ] Корзина: добавление товара
├─ [ ] Корзина: удаление товара
├─ [ ] Корзина: изменение количества
├─ [ ] Корзина: сохранение в localStorage
├─ [ ] Переключение комнат (orange ↔ blue)
└─ [ ] Загрузка при перезагрузке страницы


ПОСЛЕ ФАЗЫ 4 (Модальные окна):
├─ [ ] Эхо карточки открываются
├─ [ ] Импорт из эхо карточки работает
├─ [ ] Корзина открывается
├─ [ ] Создание проекта из корзины
└─ [ ] Все модалки закрываются корректно


ФИНАЛЬНАЯ ПРОВЕРКА:
├─ [ ] Все сценарии из production
├─ [ ] Performance не хуже
├─ [ ] TypeScript без ошибок
├─ [ ] ESLint без ошибок
└─ [ ] Нет console warnings
```

---

**Создано:** 2025-11-29
**Связанные документы:**
- CATALOG_PAGE_DECOMPOSITION_ANALYSIS.md (полный анализ)
- CATALOG_DECOMPOSITION_QUICK_GUIDE.md (быстрый гайд)
