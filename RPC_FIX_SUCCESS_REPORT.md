# ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê: RPC —Ñ—É–Ω–∫—Ü–∏—è get_products_by_category

## –°–¢–ê–¢–£–°: –†–ï–®–ï–ù–û

**–î–∞—Ç–∞:** 2025-11-27
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ 32 —Ç–æ–≤–∞—Ä–∞ –≤–º–µ—Å—Ç–æ 1

---

## –ù–ê–ô–î–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∞–ª–∏–∞—Å–æ–≤ –≤ SQL –∑–∞–ø—Ä–æ—Å–µ

–í —Å—Ç—Ä–æ–∫–∞—Ö **115-123** –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥:

```sql
-- ‚ùå –ü–†–û–ë–õ–ï–ú–ù–´–ô –ö–û–î
all_products AS (
    SELECT * FROM verified_products
    UNION ALL
    SELECT * FROM user_products
)

SELECT COALESCE(
    jsonb_agg(row_to_json(all_products)::JSONB ORDER BY product_name),
    '[]'::JSONB
) INTO result
FROM (
    SELECT * FROM all_products
    LIMIT limit_param
    OFFSET offset_param
) all_products;  -- ‚ùå –ê–ª–∏–∞—Å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏–º–µ–Ω–µ–º CTE!
```

### –ü—Ä–∏—á–∏–Ω–∞ –±–∞–≥–∞

1. CTE (Common Table Expression) –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `all_products`
2. –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ `FROM` —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ª–∏–∞—Å `all_products`
3. –í `row_to_json(all_products)` PostgreSQL –Ω–µ –∑–Ω–∞–µ—Ç –∫ —á–µ–º—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è
4. –ò–∑-–∑–∞ —ç—Ç–æ–π –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ —Ç–æ–ª—å–∫–æ 1 —Å—Ç—Ä–æ–∫—É

---

## –†–ï–®–ï–ù–ò–ï

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ SQL

```sql
-- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î
all_products AS (
    SELECT * FROM verified_products
    UNION ALL
    SELECT * FROM user_products
)

SELECT COALESCE(
    jsonb_agg(to_jsonb(p.*) ORDER BY p.product_name),
    '[]'::JSONB
) INTO result
FROM (
    SELECT * FROM all_products
    ORDER BY product_name
    LIMIT limit_param
    OFFSET offset_param
) p;  -- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π –∞–ª–∏–∞—Å 'p'
```

### –ö–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ê–ª–∏–∞—Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞** –∏–∑–º–µ–Ω–µ–Ω —Å `all_products` –Ω–∞ `p`
2. **–§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏** –∏–∑–º–µ–Ω–µ–Ω–∞ —Å `row_to_json()` –Ω–∞ `to_jsonb()` –¥–ª—è –ª—É—á—à–µ–π —Ä–∞–±–æ—Ç—ã —Å JSONB
3. **–î–æ–±–∞–≤–ª–µ–Ω `ORDER BY`** –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ LIMIT –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
4. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫**:
   - `s.completed_projects` ‚Üí `s.projects_count` (–¥–ª—è verified_suppliers)
   - `s.rating` ‚Üí `s.user_rating` (–¥–ª—è user_suppliers)
   - `0` ‚Üí `s.total_projects` (–¥–ª—è user_suppliers)

---

## –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –¢–µ—Å—Ç 1: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
- **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 1 —Ç–æ–≤–∞—Ä
- **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 32 —Ç–æ–≤–∞—Ä–∞
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û

### –¢–µ—Å—Ç 2: LIMIT —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ó–∞–ø—Ä–æ—Å:** `limit_param: 10`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 10 —Ç–æ–≤–∞—Ä–æ–≤
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û

### –¢–µ—Å—Ç 3: –ü–æ–ª–µ images –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–ü–æ–ª–µ `images`:** –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–ü–æ–ª–µ `image_url`:** –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û

---

## –ü–†–ò–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `supabase/migrations/20251127_fix_rpc_alias_conflict.sql`
- –°–æ–∑–¥–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ `get_products_by_category`
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —á–µ—Ä–µ–∑ `psql` –∫ production –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 2. –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- `scripts/apply-fix-rpc-migration.js` - –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
- `scripts/test-rpc-fix.js` - –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨

–§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã:

```javascript
// –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ —á–µ—Ä–µ–∑ Supabase –∫–ª–∏–µ–Ω—Ç
const { data, error } = await supabase.rpc('get_products_by_category', {
  category_name: '–¢–ï–°–¢–û–í–ê–Ø',
  user_id_param: null,
  search_query: null,
  limit_param: 100,
  offset_param: 0
})

// –†–µ–∑—É–ª—å—Ç–∞—Ç: –º–∞—Å—Å–∏–≤ –∏–∑ 32 —Ç–æ–≤–∞—Ä–æ–≤
```

---

## –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ö–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `id` - UUID —Ç–æ–≤–∞—Ä–∞
- `product_name` - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- `category` - –ö–∞—Ç–µ–≥–æ—Ä–∏—è
- `price`, `currency` - –¶–µ–Ω–∞ –∏ –≤–∞–ª—é—Ç–∞
- `images` - –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (JSONB)
- `image_url` - URL –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `supplier_id` - ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- `supplier_name` - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- `supplier_rating` - –†–µ–π—Ç–∏–Ω–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
- `supplier_reviews` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤
- `supplier_projects` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤
- `room_type` - –¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã ('verified' –∏–ª–∏ 'user')
- `room_icon` - –ò–∫–æ–Ω–∫–∞ –∫–æ–º–Ω–∞—Ç—ã ('üü†' –∏–ª–∏ 'üîµ')
- `room_description` - –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

- `category_name` (TEXT) - –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (nullable)
- `user_id_param` (UUID) - –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è user_products (nullable)
- `search_query` (TEXT) - –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é (nullable)
- `limit_param` (INT) - –õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (default: 50)
- `offset_param` (INT) - –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (default: 0)

---

## –í–õ–ò–Ø–ù–ò–ï –ù–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–ï

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. API endpoint `/api/catalog/products-by-category/–¢–ï–°–¢–û–í–ê–Ø` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ 32 —Ç–æ–≤–∞—Ä–∞
2. UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ProductGridByCategory` –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
3. –°—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
4. –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
5. –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º

---

## –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤—ã–∑–≤–∞–Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º –±–∞–≥–æ–º - **–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–º –∏–º–µ–Ω –∞–ª–∏–∞—Å–æ–≤ –≤ SQL**.

PostgreSQL –Ω–µ –º–æ–≥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ `all_products` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ `row_to_json()`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é —Ñ—É–Ω–∫—Ü–∏–∏.

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–µ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–µ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∞–ª–∏–∞—Å–∞ `p` –¥–ª—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞ —É—Å—Ç—Ä–∞–Ω–∏–ª–æ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å –∏ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è.

**–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.**
