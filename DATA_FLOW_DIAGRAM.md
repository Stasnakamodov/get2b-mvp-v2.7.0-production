# ДИАГРАММА ПОТОКА ДАННЫХ

## АРХИТЕКТУРА СИСТЕМЫ

```
┌─────────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬСКИЙ ИНТЕРФЕЙС                  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │ page.tsx (app/dashboard/catalog/page.tsx)                   │  │
│  │ - Управляет выбором категории и подкатегории              │  │
│  │ - selectedCategoryData = категория                          │  │
│  │ - selectedSubcategoryData = подкатегория                   │  │
│  └────────────┬────────────────────────────────┬──────────────┘  │
│               │                                │                   │
│               │ props                          │ props              │
│               ↓                                ↓                    │
│  ┌──────────────────────┐    ┌──────────────────────────────────┐ │
│  │ SubcategoryList      │    │ ProductGridByCategory ❌          │ │
│  │                      │    │                                   │ │
│  │ - Показывает список  │    │ - Загружает товары               │ │
│  │   подкатегорий       │    │ - selectedCategory ✅             │ │
│  │ - Правильные         │    │ - selectedSubcategory ❌ НЕТУ!   │ │
│  │   счётчики товаров   │    │ - Отправляет имя в API           │ │
│  │ ✅ РАБОТАЕТ ПРАВИЛЬНО│    │ ❌ НЕПРАВИЛЬНО: только категория │ │
│  └──────────────────────┘    └──────────────────────────────────┘ │
│                                                                     │
└──────────────────┬──────────────────────────┬──────────────────────┘
                   │ fetch                    │ fetch
                   ↓                          ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      БЭКЕНД - API ENDPOINTS                         │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ /api/catalog/categories                                      │  │
│  │ - Загружает категории с подкатегориями                      │  │
│  │ - Подсчитывает товары правильно                              │  │
│  │ ✅ РАБОТАЕТ: ищет по subcategory_id                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ /api/catalog/products-by-category/[category]                │  │
│  │ - Получает параметр из URL: category                        │  │
│  │ - Вызывает RPC функцию с этим параметром                    │  │
│  │ ✅ РАБОТАЕТ: но получает неправильный параметр             │  │
│  │ Текущий параметр: "ТЕСТОВАЯ" ❌                             │  │
│  │ Должен быть: "Тестовые товары" ✅ (когда выбрана подкат.)   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└────────────────────────┬────────────────────────────────────────────┘
                         │ RPC call
                         ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    БАЗА ДАННЫХ - RPC ФУНКЦИЯ                       │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ get_products_by_category(category_name)                      │  │
│  │                                                               │  │
│  │ SQL логика:                                                   │  │
│  │ SELECT * FROM catalog_verified_products p                    │  │
│  │ LEFT JOIN catalog_subcategories sub                          │  │
│  │   ON p.subcategory_id = sub.id                              │  │
│  │ WHERE (                                                       │  │
│  │   p.category = category_name              [1]               │  │
│  │   OR sub.name = category_name             [2]               │  │
│  │ )                                                             │  │
│  │                                                               │  │
│  │ Когда category_name = "ТЕСТОВАЯ":                            │  │
│  │ ✅ Условие [1] матчится → находит товары категории          │  │
│  │ ❌ Условие [2] не матчится → нет подкатегории с этим имен.  │  │
│  │ Результат: система не знает какую подкатегорию показать ❌   │  │
│  │                                                               │  │
│  │ Когда category_name = "Тестовые товары":                    │  │
│  │ ❌ Условие [1] не матчится → товары в "ТЕСТОВАЯ", не "ТТ"  │  │
│  │ ✅ Условие [2] матчится → находит товары подкатегории       │  │
│  │ Результат: находит и показывает товары ✅                    │  │
│  │                                                               │  │
│  │ ✅ ФУНКЦИЯ РАБОТАЕТ ПРАВИЛЬНО!                              │  │
│  │ Проблема в том, что API отправляет ей неправильный параметр │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└────────────────────────┬────────────────────────────────────────────┘
                         │ JSONB результат
                         ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        ТАБЛИЦЫ БД                                   │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ catalog_categories                                           │  │
│  │ ┌──────────┬─────────────────────────────┐                  │  │
│  │ │ id       │ name                        │                  │  │
│  │ ├──────────┼─────────────────────────────┤                  │  │
│  │ │ uuid-1   │ ТЕСТОВАЯ                    │ ← категория      │  │
│  │ │ uuid-2   │ Другая                      │                  │  │
│  │ └──────────┴─────────────────────────────┘                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ catalog_subcategories                                        │  │
│  │ ┌──────────┬──────────────┬───────────────────────┐          │  │
│  │ │ id       │ category_id  │ name                  │          │  │
│  │ ├──────────┼──────────────┼───────────────────────┤          │  │
│  │ │ uuid-Y   │ uuid-1       │ Тестовые товары       │ ← подкат │  │
│  │ │ uuid-Z   │ uuid-1       │ Смартфоны             │ ← подкат │  │
│  │ │ uuid-W   │ uuid-1       │ Ноутбуки              │ ← подкат │  │
│  │ └──────────┴──────────────┴───────────────────────┘          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ catalog_verified_products                                    │  │
│  │ ┌──────┬─────────────────┬──────────────┬──────────────┐     │  │
│  │ │ id   │ name            │ category     │ subcategory_ │     │  │
│  │ │      │                 │              │ id           │     │  │
│  │ ├──────┼─────────────────┼──────────────┼──────────────┤     │  │
│  │ │ 1    │ Смартфон Samsung│ ТЕСТОВАЯ     │ uuid-Y ✅    │     │  │
│  │ │ 2    │ Смартфон iPhone │ ТЕСТОВАЯ     │ uuid-Y ✅    │     │  │
│  │ │ 3    │ Смартфон Xiaomi │ ТЕСТОВАЯ     │ uuid-Y ✅    │     │  │
│  │ │ ... (еще 108 товаров в uuid-Y)                      │     │  │
│  │ │ 111  │ Смартфон Poco   │ ТЕСТОВАЯ     │ uuid-Y ✅    │     │  │
│  │ │ 112  │ Ноутбук Asus    │ ТЕСТОВАЯ     │ uuid-Z       │     │  │
│  │ │ ... (товары в других подкатегориях)                  │     │  │
│  │ └──────┴─────────────────┴──────────────┴──────────────┘     │  │
│  │                                                              │  │
│  │ Вывод:                                                       │  │
│  │ - 111 товаров имеют subcategory_id = uuid-Y                 │  │
│  │   (подкатегория "Тестовые товары")                           │  │
│  │ - Это установлено правильно при добавлении товаров          │  │
│  │ - БД готова к фильтрации по подкатегориям                  │  │
│  │ ✅ СТРУКТУРА ПРАВИЛЬНАЯ                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## ТЕКУЩИЙ ТОК ДАННЫХ (НЕПРАВИЛЬНЫЙ)

```
┌─────────────────────────┐
│ Пользователь выбирает   │
│ подкатегорию            │
│ "Тестовые товары"       │
└────────────┬────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ page.tsx                                 │
│ handleSubcategorySelect(subcategory)     │
│ ↓                                        │
│ setSelectedSubcategoryData({              │
│   id: uuid-Y,                            │
│   name: "Тестовые товары",              │
│   products_count: 111,                   │
│   ...                                    │
│ })                                       │
│ ✅ Подкатегория сохранена в состояние   │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ page.tsx условие:                        │
│ !selectedSubcategoryData ? ПОКАЗАТЬ      │
│                            ПОДКАТЕГОРИИ :│
│                            ПОКАЗАТЬ      │
│                            ТОВАРЫ        │
│                                          │
│ selectedSubcategoryData ≠ null           │
│ ↓                                        │
│ Показываем товары (УРОВЕНЬ 3)           │
│ ✅ Логика правильная                     │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ <ProductGridByCategory                   │
│   selectedCategory={selectedCategory}    │
│   ❌ ПРОБЛЕМА: передаём имя категории   │
│   ❌ НЕ передаём подкатегорию            │
│ />                                       │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ ProductGridByCategory компонент          │
│                                          │
│ props: {                                 │
│   selectedCategory: "ТЕСТОВАЯ" ✅       │
│   selectedSubcategory: undefined ❌      │
│ }                                        │
│                                          │
│ loadProducts() {                         │
│   fetch('/api/.../ТЕСТОВАЯ') ❌         │
│ }                                        │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ API /products-by-category/ТЕСТОВАЯ       │
│                                          │
│ RPC('get_products_by_category',          │
│   category_name: "ТЕСТОВАЯ" ❌          │
│ )                                        │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ RPC функция в БД                         │
│                                          │
│ WHERE (                                  │
│   p.category = "ТЕСТОВАЯ"    ✅ матчится│
│   OR sub.name = "ТЕСТОВАЯ"   ❌ не мат. │
│ )                                        │
│                                          │
│ Находит: 111 товаров категории          │
│                                          │
│ Но система не знает что нужна            │
│ подкатегория "Тестовые товары"          │
│ Результат: 0 товаров показано ❌         │
└──────────────────────────────────────────┘
```

---

## ПРАВИЛЬНЫЙ ТОК ДАННЫХ (ПОСЛЕ ИСПРАВЛЕНИЯ)

```
┌─────────────────────────┐
│ Пользователь выбирает   │
│ подкатегорию            │
│ "Тестовые товары"       │
└────────────┬────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ page.tsx                                 │
│ handleSubcategorySelect(subcategory)     │
│ ↓                                        │
│ setSelectedSubcategoryData({              │
│   id: uuid-Y,                            │
│   name: "Тестовые товары",              │
│   products_count: 111,                   │
│   ...                                    │
│ })                                       │
│ ✅ Подкатегория сохранена в состояние   │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ page.tsx условие:                        │
│ !selectedSubcategoryData ? ПОКАЗАТЬ      │
│                            ПОДКАТЕГОРИИ :│
│                            ПОКАЗАТЬ      │
│                            ТОВАРЫ        │
│                                          │
│ selectedSubcategoryData ≠ null           │
│ ↓                                        │
│ Показываем товары (УРОВЕНЬ 3)           │
│ ✅ Логика правильная                     │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ <ProductGridByCategory                   │
│   selectedCategory={selectedCategory}    │
│   selectedSubcategory={selectedSubcat}   │
│   ✅ ИСПРАВЛЕНО: передаём подкатегорию  │
│ />                                       │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ ProductGridByCategory компонент          │
│                                          │
│ props: {                                 │
│   selectedCategory: "ТЕСТОВАЯ" ✅       │
│   selectedSubcategory: {                │
│     id: uuid-Y,                         │
│     name: "Тестовые товары",           │
│     ...                                 │
│   } ✅                                   │
│ }                                        │
│                                          │
│ loadProducts() {                         │
│   const categoryName =                  │
│     selectedSubcategory?.name ||        │
│     selectedCategory                    │
│   // categoryName = "Тестовые товары"  │
│   fetch('/api/.../Тестовые товары') ✅ │
│ }                                        │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ API /products-by-category/Тестовые товары│
│                                          │
│ RPC('get_products_by_category',          │
│   category_name: "Тестовые товары" ✅   │
│ )                                        │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ RPC функция в БД                         │
│                                          │
│ WHERE (                                  │
│   p.category = "Тестовые товары" ❌     │
│   OR sub.name = "Тестовые товары" ✅    │
│ )                                        │
│ ✅ МАТЧИТСЯ!                             │
│                                          │
│ Находит: все товары где                 │
│ category = "ТЕСТОВАЯ" AND                │
│ subcategory_id = uuid-Y                 │
│                                          │
│ Результат: 111 товаров найдено ✅       │
└────────────┬────────────────────────────┘
             │
             ↓
┌──────────────────────────────────────────┐
│ ProductGridByCategory компонент          │
│                                          │
│ Загружает и показывает:                  │
│ 111 товаров подкатегории                │
│ "Тестовые товары" ✅                     │
│                                          │
│ Пользователь видит товары ✅             │
└──────────────────────────────────────────┘
```

---

## КЛЮЧЕВЫЕ СВЯЗИ В БД

```
1. Категория связана с подкатегориями:
   catalog_categories (id=X) ← catalog_subcategories (category_id=X)

2. Товары связаны с подкатегориями:
   catalog_verified_products (subcategory_id=Y) → catalog_subcategories (id=Y)

3. Товары также содержат имя категории:
   catalog_verified_products (category="ТЕСТОВАЯ", subcategory_id=Y)

4. API подсчитывает товары правильно:
   SELECT COUNT(*) FROM catalog_verified_products
   WHERE subcategory_id = Y
   RESULT: 111 товаров

5. Но ProductGridByCategory не использует эту информацию:
   - Не получает Y (id подкатегории)
   - Не получает имя подкатегории
   - Отправляет только имя категории

Решение: Передать имя подкатегории в компонент и использовать его для API запроса
```

