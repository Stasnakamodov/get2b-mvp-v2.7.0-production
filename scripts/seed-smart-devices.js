/**
 * Standalone скрипт: создание подкатегории "Умные устройства и IoT"
 * и наполнение 400 уникальными товарами.
 *
 * Запуск: node scripts/seed-smart-devices.js
 */

const { createClient } = require('@supabase/supabase-js')
const crypto = require('crypto')

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://ejkhdhexkadecpbjjmsz.supabase.co'
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqa2hkaGV4a2FkZWNwYmpqbXN6Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NzAzNzE0MiwiZXhwIjoyMDYyNjEzMTQyfQ.MH6oMEsLySC08YsLIjOfeweGtvfGg_vNl-d3sc5L6Lg'

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: { autoRefreshToken: false, persistSession: false }
})

// ─── Данные ─────────────────────────────────────────────────────────────────

const BRANDS = [
  'Xiaomi', 'Tuya', 'Sonoff', 'Aqara', 'Yeelight', 'BroadLink', 'Zigbee Pro',
  'Gosund', 'BlitzWolf', 'MOES', 'Zemismart', 'Aubess', 'Bardi', 'Teckin',
  'Meross', 'SwitchBot', 'Shelly', 'Wiz', 'TP-Link Tapo', 'Baseus'
]

const COLORS = [
  'белый', 'чёрный', 'серый', 'серебристый', 'синий',
  'зелёный', 'бежевый', 'матовый чёрный', 'розовое золото', 'тёмно-серый'
]

const TEMPLATES = [
  {
    type: 'Умная розетка',
    variants: ['Wi-Fi с мониторингом энергии', 'Zigbee мини', 'с USB портами', 'влагозащищённая IP44', 'с таймером', 'двойная', 'с голосовым управлением', 'накладная 16A', 'встраиваемая', 'с датчиком температуры'],
    features: [['мониторинг энергии', 'таймер', 'голосовое управление'], ['компактный размер', 'защита от перегрузки', 'расписание'], ['дистанционное управление', 'группировка устройств', 'сценарии']],
    priceRange: [450, 2800],
    specs: [{ 'Макс. нагрузка': '16A/3680W', 'Протокол': 'Wi-Fi 2.4GHz', 'Совместимость': 'Алиса, Google Home' }, { 'Макс. нагрузка': '10A/2300W', 'Протокол': 'Zigbee 3.0', 'Совместимость': 'Tuya, SmartLife' }]
  },
  {
    type: 'Умная лампочка',
    variants: ['RGB E27 9W', 'тёплый белый E14', 'LED GU10 диммируемая', 'филаментная E27 винтаж', 'RGB лента 5м', 'настольная с ночником', 'потолочная панель 24W', 'GU5.3 спот', 'E27 12W холодный', 'RGB E27 15W'],
    features: [['16 млн цветов', 'диммирование', 'музыкальный режим'], ['тёплый/холодный свет', 'таймер сна', 'эффект рассвета'], ['группировка ламп', 'сцены освещения', 'энергосбережение']],
    priceRange: [350, 3500],
    specs: [{ 'Мощность': '9W', 'Цоколь': 'E27', 'Цвет. температура': '2700-6500K' }, { 'Мощность': '12W', 'Цоколь': 'E27', 'Яркость': '1100 лм' }]
  },
  {
    type: 'Датчик температуры и влажности',
    variants: ['с LCD дисплеем', 'миниатюрный Zigbee', 'для теплицы уличный', 'с внешним зондом', 'с подключением к хабу', 'автономный BLE', 'промышленный -40..+80', 'для серверной', 'для детской комнаты', 'с часами'],
    features: [['точность ±0.3°C', 'история данных', 'уведомления'], ['компактный', 'батарея CR2032', 'магнитное крепление'], ['графики в приложении', 'экспорт данных', 'автоматизация']],
    priceRange: [400, 2500],
    specs: [{ 'Диапазон': '-20..+60°C', 'Точность': '±0.3°C', 'Батарея': 'CR2032, 12 мес' }, { 'Протокол': 'Zigbee 3.0', 'Обновление': 'каждые 5 сек' }]
  },
  {
    type: 'Умный выключатель',
    variants: ['сенсорный 1 клавиша', 'сенсорный 2 клавиши', 'сенсорный 3 клавиши', 'кнопочный с подсветкой', 'без нулевого провода', 'с диммером', 'для рольставней', 'проходной двойной', 'с датчиком движения', 'стеклянная панель'],
    features: [['сенсорное управление', 'подсветка LED', 'голосовое управление'], ['расписание', 'обратный отсчёт', 'блокировка от детей'], ['закалённое стекло', 'не требует нулевого провода', 'совместимость с Алисой']],
    priceRange: [700, 4500],
    specs: [{ 'Нагрузка': '600W/канал', 'Панель': 'закалённое стекло', 'Установка': 'EU 86мм' }, { 'Протокол': 'Wi-Fi 2.4GHz', 'Питание': '100-240V AC' }]
  },
  {
    type: 'IP камера',
    variants: ['поворотная 360° 2K', 'уличная 4MP PoE', 'с солнечной панелью', 'мини скрытая 1080p', 'дверной видеозвонок', 'радионяня с камерой', 'панорамная fisheye', 'PTZ с автослежением', 'двухобъективная', 'с прожектором'],
    features: [['ночное видение 10м', 'детекция движения', 'двусторонняя связь'], ['облачное хранение', 'microSD 256GB', 'AI распознавание'], ['уведомления', 'зоны детекции', 'тайм-лапс']],
    priceRange: [1200, 8500],
    specs: [{ 'Разрешение': '2K (2304x1296)', 'Угол обзора': '360°/115°', 'Ночное видение': 'ИК 10м' }, { 'Питание': '5V/2A USB-C', 'Хранение': 'microSD 256GB + облако' }]
  },
  {
    type: 'Умный замок',
    variants: ['со сканером отпечатка', 'с кодовой панелью', 'электронный с NFC', 'с камерой и видеозвонком', 'врезной металл. дверь', 'накладной Smart', 'с Bluetooth', 'с автоблокировкой', 'биометрический 100 отп.', 'мини для шкафа'],
    features: [['отпечаток пальца 0.3с', '100 пользователей', 'временные пароли'], ['аварийное питание USB', 'история открытий', 'NFC карта'], ['дистанционное открытие', 'авто-блокировка', 'тревога при взломе']],
    priceRange: [2500, 18000],
    specs: [{ 'Тип': 'врезной', 'Открытие': 'отпечаток/код/NFC/ключ/приложение', 'Батарея': '4xAA, 12 мес' }, { 'Материал': 'цинковый сплав', 'Память': '100 отп./50 паролей' }]
  },
  {
    type: 'Робот-пылесос',
    variants: ['с лидаром и влажной уборкой', 'бюджетный гироскопный', 'с самоочисткой базы', 'для шерсти животных', 'компактный для студии', 'с камерой навигации', 'с горячей сушкой мопов', 'ультратонкий 5.5см', 'с автоподъёмом мопов', 'с УФ-стерилизацией'],
    features: [['LiDAR навигация', 'построение карты', 'зоны запрета'], ['сила всасывания 4000Па', 'влажная уборка', 'автовозврат на базу'], ['управление через приложение', 'голосовое управление', 'расписание уборки']],
    priceRange: [5500, 45000],
    specs: [{ 'Всасывание': '4000 Па', 'Батарея': '5200мАч/180мин', 'Пылесборник': '400мл' }, { 'Навигация': 'LiDAR + SLAM', 'Бак для воды': '300мл', 'Шум': '<65дБ' }]
  },
  {
    type: 'Умный хаб',
    variants: ['Zigbee 3.0 универсальный', 'Zigbee+BLE combo', 'с Ethernet портом', 'мини USB', 'с встроенным динамиком', 'Matter-совместимый', 'с ИК-передатчиком', 'Thread Border Router', 'для кондиционеров', 'мультипротокольный'],
    features: [['128 устройств', 'локальная автоматизация', 'сценарии'], ['Zigbee+Wi-Fi+BLE', 'OTA обновления', 'резервное питание'], ['совместимость Алиса/Google', 'простая настройка', 'API']],
    priceRange: [1200, 6500],
    specs: [{ 'Протоколы': 'Zigbee 3.0+Wi-Fi+BLE', 'Макс. устройств': '128', 'Питание': '5V/1A USB' }, { 'Процессор': 'ARM Cortex-M4', 'Радиус': '30м' }]
  },
  {
    type: 'Умный пульт ДУ',
    variants: ['ИК универсальный', 'с датчиком температуры', 'для кондиционера', 'для ТВ и мультимедиа', 'мини подключаемый', 'с голосовым управлением', 'для вентилятора', 'обучаемый 360°', 'для тёплого пола', 'с расписанием'],
    features: [['база 50000 устройств', 'обучение ИК команд', 'голосовое управление'], ['расписание', 'сценарии по температуре', 'дистанционное управление'], ['встроенный датчик t°', 'LED индикатор', 'компактный']],
    priceRange: [600, 3000],
    specs: [{ 'ИК дальность': '10м/360°', 'Частота': '38кГц', 'Питание': '5V micro-USB' }, { 'Протокол': 'Wi-Fi 2.4GHz', 'Совместимость': 'Алиса, Google, Siri' }]
  },
  {
    type: 'Датчик движения',
    variants: ['PIR с углом 170°', 'миниатюрный батарейка', 'уличный IP65', 'для лестницы', 'с датчиком освещённости', 'потолочный 360°', 'для шкафа с подсветкой', 'Zigbee проводной', 'с сиреной', 'для автоматизации света'],
    features: [['дальность 7м', 'угол 170°', 'регулировка чувствительности'], ['батарея 2 года', 'компактный', 'магнитное крепление'], ['интеграция сценариев', 'уведомления', 'лог событий']],
    priceRange: [350, 2200],
    specs: [{ 'Тип': 'PIR инфракрасный', 'Дальность': '7м', 'Угол': '170°' }, { 'Протокол': 'Zigbee 3.0', 'Температура': '-10..+45°C' }]
  },
  {
    type: 'Умный термостат',
    variants: ['для тёплого пола', 'для газового котла', 'для электр. отопления', 'с LCD сенсорным экраном', 'программируемый 7 дней', 'с датчиком пола', 'для фанкойла', 'с OpenTherm', 'для водяного т/п', 'с Wi-Fi модулем'],
    features: [['точность ±0.5°C', 'недельное расписание', 'энергосбережение 30%'], ['сенсорный экран', 'блокировка от детей', 'адаптивный нагрев'], ['история температуры', 'геолокация', 'интеграция с умным домом']],
    priceRange: [1500, 7000],
    specs: [{ 'Нагрузка': '16A/3600W', 'Датчик': 'NTC 10K встр.+внешний', 'Точность': '±0.5°C' }, { 'Экран': '3.5" LCD сенсорный', 'Питание': '95-240V AC' }]
  },
  {
    type: 'Датчик открытия двери',
    variants: ['миниатюрный магнитный', 'с вибрацией и наклоном', 'для гаражных ворот', 'для рольставней', 'с датчиком света', 'для холодильника', 'промышленный с кабелем', 'со звуковым оповещением', 'Zigbee мини', 'с таймером открытия'],
    features: [['мгновенное уведомление', 'история событий', 'триггер для сценариев'], ['батарея 18 мес', 'водонепроницаемый', '3М скотч'], ['детекция наклона', 'счётчик открытий', 'лог событий']],
    priceRange: [300, 1800],
    specs: [{ 'Тип': 'геркон+магнит', 'Зазор': '15мм', 'Батарея': 'CR2032, 18 мес' }, { 'Протокол': 'Zigbee 3.0', 'Размер': '41x22x11мм' }]
  },
  {
    type: 'Умная колонка',
    variants: ['с Алисой мини', 'с экраном 7"', 'портативная Bluetooth', 'стерео пара', 'с часами и будильником', 'для детской с ночником', 'Hi-Fi с сабвуфером', 'с батареей 10ч', 'с LED подсветкой', 'компактная настольная'],
    features: [['голосовой помощник', 'управление умным домом', 'стриминг музыки'], ['мультирум', 'AUX вход', 'Bluetooth 5.0'], ['будильник', 'радио', 'подкасты']],
    priceRange: [1500, 12000],
    specs: [{ 'Динамик': '5W', 'Микрофон': '4 массив с AEC', 'Подключение': 'Wi-Fi+BLE' }, { 'Батарея': '3000мАч/8ч', 'Размер': '95x95x45мм' }]
  },
  {
    type: 'Датчик протечки воды',
    variants: ['автономный с сиреной', 'Zigbee с кабелем 2м', 'с перекрытием клапана', 'для стиральной машины', 'для ванной', 'промышленный IP67', 'с внешним зондом', 'Wi-Fi миниатюрный', 'с тросом-датчиком 5м', 'набор 3шт'],
    features: [['оповещение 85дБ', 'push-уведомление', 'автоперекрытие воды'], ['батарея 3 года', 'низкий профиль 8мм', 'золотые контакты'], ['тестовая кнопка', 'индикация батареи', 'работа в -10°C']],
    priceRange: [450, 3500],
    specs: [{ 'Чувствительность': '0.5мм', 'Сирена': '85дБ', 'Батарея': 'AAAx2, 3 года' }, { 'Защита': 'IP67', 'Кабель': '2м' }]
  },
  {
    type: 'Умный привод для штор',
    variants: ['для карниза до 5м', 'для рулонных штор', 'на солнечной батарее', 'Zigbee тихий мотор', 'с пультом ДУ', 'для вертикальных жалюзи', 'реверсивный 12V', 'для тяжёлых штор 50кг', 'роботизированный мини', 'цепочный'],
    features: [['тихий мотор <35дБ', 'расписание по солнцу', 'голосовое управление'], ['авто-калибровка', 'плавное открытие', 'фиксация в любом положении'], ['солнечная зарядка', 'батарея 6 мес', 'USB-C']],
    priceRange: [2000, 9500],
    specs: [{ 'Макс. карниз': '5м', 'Тяга': '50кг', 'Шум': '<35дБ' }, { 'Питание': 'солнечная+3000мАч', 'Скорость': '12см/с' }]
  },
  {
    type: 'Умные весы',
    variants: ['напольные с анализом тела', 'кухонные с приложением', 'для ребёнка с кривой роста', 'для спортсмена 13 параметров', 'мини портативные', 'напольные до 180кг', 'стеклянные с подсветкой', 'с Bluetooth 5.0', 'для семьи 8 профилей', 'точные шаг 50г'],
    features: [['13 параметров тела', 'Apple Health/Google Fit', 'распознавание пользователей'], ['ITO покрытие', 'закалённое стекло 6мм', 'LED дисплей'], ['график динамики веса', 'BMI/жир/вода', 'безопасно для кардиостимуляторов']],
    priceRange: [800, 5000],
    specs: [{ 'Макс. вес': '180кг', 'Точность': '50г', 'Параметры': '13 показателей' }, { 'Подключение': 'Bluetooth 5.0', 'Батарея': '3xAAA' }]
  },
  {
    type: 'Умный увлажнитель',
    variants: ['ультразвуковой 4л', 'с ароматизацией', 'для комнаты 40м²', 'мини USB для стола', 'с гигростатом', 'холодный/горячий пар', 'для растений с таймером', 'тихий <26дБ', 'с подсветкой RGB', 'промышленный 10л'],
    features: [['автоподдержание влажности', 'бесшумный <26дБ', 'таймер'], ['аромакапсула', 'антибактериальный фильтр', 'ночной режим'], ['Wi-Fi управление', 'расписание', 'индикация уровня воды']],
    priceRange: [1200, 7500],
    specs: [{ 'Объём': '4л', 'Площадь': '40м²', 'Шум': '<26дБ' }, { 'Расход воды': '300мл/ч', 'Мощность': '30Вт' }]
  },
  {
    type: 'Умный дозатор',
    variants: ['мыла настенный', 'мыла настольный', 'антисептика ИК', 'кормушка для кота', 'поилка-фонтанчик питомец', 'зубной пасты', 'корма для рыбок', 'жидкого порошка', 'автоматический специй', 'шампуня в душ'],
    features: [['бесконтактный ИК', 'регулировка дозы', 'индикатор уровня'], ['перезаряжаемый USB-C', 'IPX5', 'тихий мотор'], ['расписание кормления', 'запись голоса хозяина', 'история в приложении']],
    priceRange: [600, 8000],
    specs: [{ 'Объём': '350мл', 'Датчик': 'ИК бесконтактный', 'Питание': 'USB-C аккум.' }, { 'Материал': 'ABS+нерж. сталь', 'Защита': 'IPX5' }]
  },
  {
    type: 'Умный очиститель воздуха',
    variants: ['HEPA H13', 'для аллергиков', 'с ионизатором', 'автомобильный 12V', 'для комнаты 60м²', 'с датчиком PM2.5', 'настольный мини', 'с UV-лампой', 'угольный для курильщиков', 'бесшумный для спальни'],
    features: [['HEPA H13 99.97%', 'авто режим', 'индикатор качества воздуха'], ['ночной режим 20дБ', 'таймер', 'блокировка от детей'], ['Wi-Fi управление', 'статистика', 'замена фильтра']],
    priceRange: [2500, 15000],
    specs: [{ 'CADR': '320м³/ч', 'Площадь': '60м²', 'Фильтр': 'HEPA H13+угольный' }, { 'Шум': '20-52дБ', 'Мощность': '40Вт' }]
  },
  {
    type: 'Умная кнопка сцен',
    variants: ['на 4 сцены', 'беспроводная SOS', 'настенная 6 кнопок', 'с диммером вращением', 'мини на скотче', 'с вибрацией', 'для кровати 2 клавиши', 'с NFC меткой', 'магнитная на холодильник', 'с часами и дисплеем'],
    features: [['запуск сцен', 'без проводов', 'батарея 3 года'], ['одинарное/двойное/длинное нажатие', 'привязка к устройствам', 'сценарии'], ['компактный', 'магнитное крепление', 'не требует установки']],
    priceRange: [400, 2500],
    specs: [{ 'Батарея': 'CR2032, 3 года', 'Протокол': 'Zigbee 3.0', 'Размер': '45x45x12мм' }, { 'Действия': '1/2/длинное нажатие', 'Совместимость': 'Tuya, Aqara' }]
  },
]

const IMAGE_PATTERNS = [
  'https://img.alicdn.com/imgextra/i1/smart_device_{id}.jpg',
  'https://img.alicdn.com/imgextra/i2/iot_product_{id}.jpg',
  'https://img.alicdn.com/imgextra/i3/home_auto_{id}.jpg',
  'https://img.alicdn.com/imgextra/i4/sensor_{id}.jpg',
  'https://ae04.alicdn.com/kf/smart_{id}_main.jpg',
]

function generateImages(idx) {
  const hash = crypto.createHash('md5').update(`product_${idx}_v3`).digest('hex')
  const count = 3 + (idx % 3)
  const images = []
  for (let i = 0; i < count; i++) {
    const imgHash = crypto.createHash('md5').update(`${hash}_img_${i}`).digest('hex').substring(0, 16)
    images.push(IMAGE_PATTERNS[(idx + i) % IMAGE_PATTERNS.length].replace('{id}', imgHash))
  }
  return images
}

function generateProducts() {
  const products = []
  const usedNames = new Set()
  let gi = 0

  for (const t of TEMPLATES) {
    for (const variant of t.variants) {
      for (let bi = 0; bi < 2; bi++) {
        const brand = BRANDS[(gi + bi) % BRANDS.length]
        const color = COLORS[gi % COLORS.length]
        const feat = t.features[gi % t.features.length]
        const spec = t.specs[gi % t.specs.length]

        const name = `${brand} ${t.type} ${variant} ${color}`
        if (usedNames.has(name.toLowerCase())) { gi++; continue }
        usedNames.add(name.toLowerCase())

        const [minP, maxP] = t.priceRange
        const price = Math.round((minP + ((gi * 137 + bi * 53) % (maxP - minP))) * 100) / 100

        const desc = [
          `${name} — ${feat[0]}, ${feat[1]}, ${feat[2]}.`,
          '', 'Характеристики:',
          ...Object.entries(spec).map(([k, v]) => `  - ${k}: ${v}`),
          '', `Бренд: ${brand}. Цвет: ${color}.`,
          'Категория: Умные устройства и IoT.',
          'Прямая поставка. Гарантия 12 месяцев.',
        ].join('\n')

        products.push({
          name, description: desc, price,
          images: generateImages(gi),
          specifications: { ...spec, 'Бренд': brand, 'Цвет': color, 'Гарантия': '12 мес', 'Маркетплейс': 'Taobao' },
        })
        gi++
        if (products.length >= 400) return products
      }
    }
  }
  return products
}

// ─── Main ───────────────────────────────────────────────────────────────────

async function main() {
  console.log('=== SEED: Умные устройства и IoT (400 товаров) ===\n')

  // 1. Категория "Электроника"
  const { data: category, error: catErr } = await supabase
    .from('catalog_categories')
    .select('id, name, key')
    .or('key.eq.electronics,name.eq.Электроника')
    .single()

  if (catErr || !category) {
    console.error('Категория "Электроника" не найдена:', catErr?.message)
    process.exit(1)
  }
  console.log(`Категория: ${category.name} (${category.id})`)

  // 2. Подкатегория
  const subKey = 'smart-devices-iot'
  let { data: sub } = await supabase
    .from('catalog_subcategories')
    .select('id, name')
    .eq('category_id', category.id)
    .eq('key', subKey)
    .single()

  if (!sub) {
    const { data: newSub, error: subErr } = await supabase
      .from('catalog_subcategories')
      .insert([{ category_id: category.id, name: 'Умные устройства и IoT', key: subKey }])
      .select().single()
    if (subErr) { console.error('Ошибка подкатегории:', subErr.message); process.exit(1) }
    sub = newSub
    console.log(`Подкатегория создана: ${sub.name}`)
  } else {
    console.log(`Подкатегория найдена: ${sub.name}`)
  }

  // 3. Поставщик
  const supplierName = 'OTAPI Smart Devices Import'
  let { data: supplier } = await supabase
    .from('catalog_verified_suppliers')
    .select('id, name').eq('name', supplierName).single()

  if (!supplier) {
    const { data: ns, error: se } = await supabase
      .from('catalog_verified_suppliers')
      .insert([{
        name: supplierName, company_name: 'Smart Devices via OTAPI',
        category: 'Электроника', country: 'Китай', city: 'Шэньчжэнь',
        description: 'Импорт умных устройств и IoT товаров.',
        is_active: true, is_verified: true, moderation_status: 'approved',
        min_order: 'От 1 шт.', public_rating: 4.7,
        certifications: ['OTAPI Partner', 'IoT Specialist'],
        specialties: ['Умные устройства', 'IoT', 'Датчики']
      }]).select().single()
    if (se) { console.error('Ошибка поставщика:', se.message); process.exit(1) }
    supplier = ns
    console.log(`Поставщик создан: ${supplier.name}`)
  } else {
    console.log(`Поставщик найден: ${supplier.name}`)
  }

  // 4. Генерация
  const products = generateProducts()
  console.log(`\nСгенерировано товаров: ${products.length}`)

  // 5. Формируем строки для БД
  const rows = products.map((p, idx) => ({
    name: p.name,
    description: p.description,
    category: 'Электроника',
    category_id: category.id,
    subcategory_id: sub.id,
    sku: `SMART-IOT-${String(idx + 1).padStart(4, '0')}`,
    price: p.price,
    currency: 'RUB',
    min_order: '1 шт.',
    in_stock: true,
    specifications: p.specifications,
    images: p.images,
    supplier_id: supplier.id,
    is_active: true,
    is_featured: idx % 10 === 0,
  }))

  // 6. Вставка батчами по 50
  let totalInserted = 0
  let totalErrors = 0
  const BATCH = 50

  for (let i = 0; i < rows.length; i += BATCH) {
    const batch = rows.slice(i, i + BATCH)
    const { data: inserted, error: batchErr } = await supabase
      .from('catalog_verified_products')
      .insert(batch)
      .select('id')

    if (batchErr) {
      console.log(`  Batch ${i / BATCH + 1}: ошибка "${batchErr.message}", fallback one-by-one...`)
      // One-by-one fallback
      for (const row of batch) {
        const { error: singleErr } = await supabase
          .from('catalog_verified_products')
          .insert([row])
        if (singleErr) {
          totalErrors++
        } else {
          totalInserted++
        }
      }
    } else {
      const count = inserted?.length || 0
      totalInserted += count
      console.log(`  Batch ${Math.floor(i / BATCH) + 1}: вставлено ${count}`)
    }
  }

  console.log(`\n=== РЕЗУЛЬТАТ ===`)
  console.log(`Сгенерировано: ${products.length}`)
  console.log(`Вставлено: ${totalInserted}`)
  console.log(`Ошибок: ${totalErrors}`)
  console.log(`Подкатегория: ${sub.name} (${sub.id})`)
}

main()
  .then(() => { console.log('\nГотово!'); process.exit(0) })
  .catch(err => { console.error('FATAL:', err); process.exit(1) })
