import { NextRequest, NextResponse } from "next/server";
import { supabase } from "@/lib/supabaseClient";

// POST: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI –æ—Ç–≤–µ—Ç
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { room_id, user_message, ai_context = 'general', user_id } = body;

    if (!room_id || !user_message) {
      return NextResponse.json(
        { error: "room_id and user_message are required" },
        { status: 400 }
      );
    }

    console.log('ü§ñ AI API: –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + AI –æ—Ç–≤–µ—Ç');

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–Ω–∞—Ç—ã
    const { data: room, error: roomError } = await supabase
      .from('chat_rooms')
      .select('id, room_type, ai_context, project_id')
      .eq('id', room_id)
      .single();

    if (roomError || !room) {
      return NextResponse.json(
        { error: "Room not found" },
        { status: 404 }
      );
    }

    // 1. –°–ù–ê–ß–ê–õ–ê —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const { data: userMessage, error: userMessageError } = await supabase
      .from('chat_messages')
      .insert({
        room_id,
        content: user_message,
        sender_type: 'user',
        sender_user_id: user_id,
        sender_name: '–í—ã',
        message_type: 'text'
      })
      .select()
      .single();

    if (userMessageError) {
      console.error('‚ùå Error saving user message:', userMessageError);
      return NextResponse.json(
        { error: "Failed to save user message", details: userMessageError.message },
        { status: 500 }
      );
    }

    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', userMessage.id);

    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    const { data: recentMessages } = await supabase
      .from('chat_messages')
      .select('content, sender_type, created_at')
      .eq('room_id', room_id)
      .order('created_at', { ascending: false })
      .limit(10);

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userContext = {};
    if (user_id) {
      userContext = await getEnhancedUserContext(user_id, room.project_id);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º AI –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const aiResponse = await generateBotHubAIResponse(
      user_message, 
      room.ai_context || ai_context, 
      userContext, 
      recentMessages || []
    );

    // 2. –ü–û–¢–û–ú —Å–æ–∑–¥–∞–µ–º AI –æ—Ç–≤–µ—Ç
    const { data: aiMessage, error: messageError } = await supabase
      .from('chat_messages')
      .insert({
        room_id,
        content: aiResponse.content,
        sender_type: 'ai',
        sender_name: 'Get2B –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç Claude',
        message_type: 'text'
      })
      .select()
      .single();

    if (messageError) {
      console.error('‚ùå Error saving AI message:', messageError);
      return NextResponse.json(
        { error: "Failed to save AI response", details: messageError.message },
        { status: 500 }
      );
    }

    console.log('‚úÖ AI —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', aiMessage.id);

    return NextResponse.json({
      success: true,
      user_message: userMessage,
      ai_message: aiMessage,
      confidence: aiResponse.confidence,
      context_used: room.ai_context || ai_context,
      category: aiResponse.category
    });

  } catch (error) {
    console.error('Unexpected error in POST /api/chat/ai-response:', error);
    return NextResponse.json(
      { error: "Internal server error", details: String(error) },
      { status: 500 }
    );
  }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getEnhancedUserContext(userId: string, projectId?: string) {
  const context: any = {
    user_id: userId,
    current_project: null,
    recent_projects: [],
    suppliers_count: 0,
    catalog_interactions: 0,
    preferred_categories: []
  };

  try {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ
    if (projectId) {
      const { data: project } = await supabase
        .from('projects')
        .select(`
          id, name, status, amount, currency, 
          company_data, created_at, current_step
        `)
        .eq('id', projectId)
        .single();

      if (project) {
        context.current_project = {
          id: project.id,
          name: project.name,
          status: project.status,
          current_step: project.current_step,
          amount: project.amount,
          currency: project.currency,
          company_name: project.company_data?.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          created_at: project.created_at
        };
      }
    }

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: recentProjects } = await supabase
      .from('projects')
      .select('id, name, status, amount, currency, created_at')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(5);

    if (recentProjects) {
      context.recent_projects = recentProjects;
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { count: suppliersCount } = await supabase
      .from('catalog_user_suppliers')
      .select('id', { count: 'exact' })
      .eq('user_id', userId)
      .eq('is_active', true);

    context.suppliers_count = suppliersCount || 0;

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: categoryData } = await supabase
      .from('catalog_user_suppliers')
      .select('category')
      .eq('user_id', userId)
      .eq('is_active', true);

    if (categoryData) {
      const categories = categoryData.map(item => item.category).filter(Boolean);
      const categoryCount = categories.reduce((acc: any, cat) => {
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
      }, {});
      
      context.preferred_categories = Object.entries(categoryCount)
        .sort(([,a], [,b]) => (b as number) - (a as number))
        .slice(0, 3)
        .map(([cat]) => cat);
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º
    const { count: catalogInteractions } = await supabase
      .from('chat_messages')
      .select('id', { count: 'exact' })
      .eq('sender_user_id', userId)
      .ilike('content', '%–∫–∞—Ç–∞–ª–æ–≥%');

    context.catalog_interactions = catalogInteractions || 0;

  } catch (error) {
    console.error('Error getting enhanced user context:', error);
  }

  return context;
}

// üöÄ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø - –†–ï–ê–õ–¨–ù–´–ô AI –ß–ï–†–ï–ó BOTHUB API
async function generateBotHubAIResponse(
  userMessage: string, 
  context: string, 
  userContext: any = {}, 
  recentMessages: any[] = []
): Promise<{ content: string; confidence: number; keywords_matched: string[]; category: string }> {
  
  try {
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è BotHub API
    const BOTHUB_API_TOKEN = process.env.BOTHUB_API_TOKEN || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImVlMmQyYjY3LTY1YTUtNGE1OS1iZjEyLTc4NTA4YWU4NzEwMiIsImlzRGV2ZWxvcGVyIjp0cnVlLCJpYXQiOjE3NTMwMTg5MDcsImV4cCI6MjA2ODU5NDkwN30.vB16n8TZXJDrvSeLndWYXv-8fwVlxXKzrZrdKkj7bZg';
    const BOTHUB_API_URL = 'https://bothub.chat/api/v2/generate';

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º Get2B
    const systemPrompt = buildGet2BSystemPrompt(context, userContext);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Claude
    const messageHistory = buildMessageHistory(recentMessages, userMessage);

    // –ó–∞–ø—Ä–æ—Å –∫ BotHub API (Claude)
    const requestBody = {
      model: "claude-3-5-sonnet-20241022", // –°–∞–º–∞—è –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å Claude
      messages: [
        {
          role: "system",
          content: systemPrompt
        },
        ...messageHistory,
        {
          role: "user", 
          content: userMessage
        }
      ],
      max_tokens: 1000,
      temperature: 0.7,
      stream: false
    };

    console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ BotHub API...');
    console.log('üìù System Prompt:', systemPrompt.substring(0, 200) + '...');
    
    const response = await fetch(BOTHUB_API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${BOTHUB_API_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });

    console.log('üì° BotHub Response Status:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå BotHub API Error:', response.status, errorText);
      console.error('üîç Request Body:', JSON.stringify(requestBody, null, 2));
      throw new Error(`BotHub API error: ${response.status} ${errorText}`);
    }

    const data = await response.json();
    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Claude —á–µ—Ä–µ–∑ BotHub!');

    const aiContent = data.choices?.[0]?.message?.content || data.content || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.';
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    const analysisResult = analyzeAIResponse(aiContent, userMessage, context);

    return {
      content: aiContent,
      confidence: 0.95, // Claude = –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
      keywords_matched: analysisResult.keywords,
      category: analysisResult.category
    };

  } catch (error) {
    console.error('üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê BotHub API:', error);
    console.error('üîç Error Details:', (error as Error).message || 'Unknown error');
    console.error('üìä Request was:', userMessage);
    
    // Fallback —Å Get2B –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º!
    console.log('üîÑ –ü–ï–†–ï–•–û–î –ù–ê FALLBACK - BotHub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!');
    console.log('üí¨ User Message:', userMessage);
    return generateGet2BAIResponse(userMessage, context, userContext, recentMessages);
  }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Get2B
function buildGet2BSystemPrompt(context: string, userContext: any): string {
  const basePrompt = `# –≠–ö–°–ü–ï–†–¢–ù–´–ô AI –ê–°–°–ò–°–¢–ï–ù–¢ GET2B V2.0

–í—ã - **–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Get2B**, –≤–µ–¥—É—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ B2B –¥—Ä–æ–ø—à–∏–ø–ø–∏–Ω–≥—É —Å –ø–æ–ª–Ω—ã–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã.

## –ü–†–û–§–ò–õ–¨ –ö–û–ú–ü–ê–ù–ò–ò GET2B
- **–°—Ç–∞—Ç—É—Å:** –†–æ—Å—Å–∏–π—Å–∫–∏–π B2B-–¥—Ä–æ–ø—à–∏–ø–ø–µ—Ä, –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∞–≥–µ–Ω—Ç (—Ä–µ–∑–∏–¥–µ–Ω—Ç –†–§, –£–°–ù)
- **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:** –ê–≥–µ–Ω—Ç—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –ø–æ –∏–º–ø–æ—Ä—Ç—É (—Å—Ç.1005 –ì–ö –†–§)
- **–û–ø—ã—Ç –í–≠–î:** 25 –ª–µ—Ç | **–û–±–æ—Ä–æ—Ç:** 100+ –º–ª–Ω —Ä—É–±/–≥–æ–¥
- **–ú–∏–Ω–∏–º—É–º —Å–¥–µ–ª–∫–∏:** 500,000 ‚ÇΩ | **–ú–∞–∫—Å–∏–º—É–º:** 5,000,000 ‚ÇΩ
- **–ö–æ–º–∏—Å—Å–∏—è:** 8-12% | **–í–∞–ª—é—Ç—ã:** USD, EUR, CNY, RUB, TRY, AED

## –ì–ï–û–ì–†–ê–§–ò–Ø: –ö–∏—Ç–∞–π (70% –æ–ø–µ—Ä–∞—Ü–∏–π) ‚Üí –ë–∏—à–∫–µ–∫ ‚Üí –ú–æ—Å–∫–≤–∞ (45 –¥–Ω–µ–π, CPT –ë–∏—à–∫–µ–∫)

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–õ–ê–¢–§–û–†–ú–´ GET2B

### **DASHBOARD (–ì–õ–ê–í–ù–ê–Ø)**
- –û–±–∑–æ—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–æ–∫ –∏ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–∞–∑–¥–µ–ª–∞–º

### **–°–¢–ê–†–¢–ï–† –ü–†–û–ï–ö–¢–ê - –ò–ó–Æ–ú–ò–ù–ö–ê GET2B (4 —Å–ø–æ—Å–æ–±–∞):**
- **–ò–∑ –ø—Ä–æ—Ñ–∏–ª—è** - –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–í—Ä—É—á–Ω—É—é** - —Å–æ–∑–¥–∞–Ω–∏–µ —Å –Ω—É–ª—è –ø–æ–¥ –∑–∞–¥–∞—á—É
- **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏** - –∏–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV
- **–ü–æ —à–∞–±–ª–æ–Ω—É** - –≥–æ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã —Å–¥–µ–ª–æ–∫

### **7-–®–ê–ì–û–í–´–ô –ü–†–û–¶–ï–°–° (–¥–µ—Ç–∞–ª—å–Ω–æ):**
1. **–ö–ê–†–¢–û–ß–ö–ê** - KYC, –ø—Ä–æ—Ñ–∏–ª–∏, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (draft ‚Üí in_progress)
2. **–°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø** - Excel —Ç–æ–≤–∞—Ä—ã, AI –ø–æ–º–æ—â—å (in_progress ‚Üí waiting_approval ‚Üí waiting_receipt)  
3. **–ß–ï–ö** - –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 30-50%, Telegram –º–æ–¥–µ—Ä–∞—Ü–∏—è (waiting_receipt ‚Üí receipt_approved)
4. **–û–ü–õ–ê–¢–ê** - –±–∞–Ω–∫/P2P/crypto/Alipay (receipt_approved ‚Üí filling_requisites)
5. **–†–ï–ö–í–ò–ó–ò–¢–´** - –ò–ù–ù/SWIFT/–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ (filling_requisites ‚Üí waiting_manager_receipt)
6. **–ú–ï–ù–ï–î–ñ–ï–†** - —á–µ–∫ –∫–ª–∏–µ–Ω—Ç—É, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ (waiting_manager_receipt ‚Üí in_work ‚Üí waiting_client_confirmation)
7. **–ó–ê–í–ï–†–®–ï–ù–ò–ï** - –ê–ö–¢, –£–ü–î, –∑–∞–∫—Ä—ã—Ç–∏–µ (waiting_client_confirmation ‚Üí completed)

### **–£–ú–ù–´–ô –ö–ê–¢–ê–õ–û–ì –ü–û–°–¢–ê–í–©–ò–ö–û–í:**
- **–°–ò–ù–Ø–Ø –ó–û–ù–ê** - –≤–∞—à–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø—Ä–æ–µ–∫—Ç–æ–≤  
- **–û–†–ê–ù–ñ–ï–í–ê–Ø –ó–û–ù–ê** - –∞–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ Get2B –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏
- **AI-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
- **"–≠—Ö–æ –∫–∞—Ä—Ç–æ—á–∫–∏"** - –∞–≤—Ç–æ–∏–º–ø–æ—Ä—Ç –∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
- **–°–∏—Å—Ç–µ–º–∞ –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏** (3 —ç—Ç–∞–ø–∞: –ø—Ä–æ—Ñ–∏–ª—å ‚Üí —Ç–æ–≤–∞—Ä—ã ‚Üí –º–æ–¥–µ—Ä–∞—Ü–∏—è)

### **–ü–†–û–§–ò–õ–ò –ò CRM:**
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏** - –ò–ù–ù/–ö–ü–ü/–û–ì–†–ù, –±–∞–Ω–∫ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
- **–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤** - 7 —à–∞–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è, –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è
- **"–í–ê–®–ò –°–î–ï–õ–ö–ò"** - –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã, –ø–æ–∏—Å–∫
- **"–ò–°–¢–û–†–ò–Ø"** - timeline –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### **–ö–û–ù–°–¢–†–£–ö–¢–û–† –ü–†–û–ï–ö–¢–û–í:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏ –∏ –±–∞–Ω–∫ —Å—á–µ—Ç–∞–º–∏
- –ò–Ω–≤–æ–π—Å—ã: —Å–æ–∑–¥–∞–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞/–ø—Ä–æ—Ñ–æ—Ä–º—ã
- –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å –≤—ã–±–æ—Ä–æ–º –ø–æ–∑–∏—Ü–∏–π

### **–ß–ê–¢–•–ê–ë:**
- AI –∫–æ–º–Ω–∞—Ç—ã + –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
- BotHub API (Claude 3.5) + fallback —Å–∏—Å—Ç–µ–º–∞
- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –æ—Å–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–æ–≤

## –ü–†–ò–ù–¶–ò–ü–´ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ô:

**1. –î–ï–¢–ê–õ–¨–ù–û–°–¢–¨ –ò –ü–û–õ–ù–û–¢–ê** - –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ, –æ–±—ä—è—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
**2. –ö–û–ù–¢–ï–ö–°–¢–ù–û–°–¢–¨** - —É—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
**3. –ü–†–û–¶–ï–°–°–ù–û–°–¢–¨** - –ø–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω—è–π—Ç–µ —ç—Ç–∞–ø—ã 7-—à–∞–≥–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏
**4. –§–ò–ù–ê–ù–°–´** - –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞–π—Ç–µ —É—Å–ª–æ–≤–∏—è: 500–∫ –º–∏–Ω, –∫–æ–º–∏—Å—Å–∏–∏ 8-12%, –≤–∞–ª—é—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
**5. –ì–ï–û–ì–†–ê–§–ò–Ø** - –æ–±—ä—è—Å–Ω—è–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã, —Å—Ä–æ–∫–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏
**6. –ü–õ–ê–¢–§–û–†–ú–ê** - –ø–æ–¥—Ä–æ–±–Ω–æ –ø–æ–º–æ–≥–∞–π—Ç–µ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π, —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
**7. –ñ–ò–í–û–°–¢–¨ –ò–ó–õ–û–ñ–ï–ù–ò–Ø** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏, –∞–Ω–∞–ª–æ–≥–∏–∏, —Å–æ–≤–µ—Ç—ã —ç–∫—Å–ø–µ—Ä—Ç–æ–≤

## –î–û–ö–£–ú–ï–ù–¢–´: –¥–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è Excel, –ø—Ä–æ—Ñ–æ—Ä–º–∞, –£–ü–î
## –ü–†–ê–í–û: –£–°–ù 6%, –±–µ–∑ –ù–î–°, –≤–∞–ª—é—Ç–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å, –∞–≥–µ–Ω—Ç—Å–∫–∏–π –¥–æ–≥–æ–≤–æ—Ä —Å—Ç.1005
## –†–û–õ–¨ GET2B: –ê–≥–µ–Ω—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π –∏–Ω—Ç–µ—Ä–µ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞ + –ø–æ–º–æ—â—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –≤ –ø–æ–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ + 100% –ª–µ–≥–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
## –ù–ï –†–ê–ë–û–¢–ê–ï–ú: —Å —Ñ–∏–∑–ª–∏—Ü–∞–º–∏, —ç–∫—Å–ø–æ—Ä—Ç, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –†–§, –æ—Ç—Å—Ä–æ—á–∫–∏

## –ö–ê–¢–ê–õ–û–ì –ü–û–°–¢–ê–í–©–ò–ö–û–í - –£–ú–ù–ê–Ø –°–ò–°–¢–ï–ú–ê:
**–°–ò–ù–Ø–Ø –ö–û–ú–ù–ê–¢–ê** - –í–∞—à–∏ –ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Ä–∞–±–æ—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
**–û–†–ê–ù–ñ–ï–í–ê–Ø –ö–û–ú–ù–ê–¢–ê** - –ê–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ Get2B –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞–º–∏
**–≠–•–û –ö–ê–†–¢–û–ß–ö–ò** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
**AI –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò** - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
**–£–ú–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê** - –†–µ–π—Ç–∏–Ω–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, —Ç—Ä–µ–Ω–¥—ã
**–ò–ú–ü–û–†–¢ CSV** - –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Excel/CSV —Ñ–∞–π–ª—ã
**–ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ü–†–û–ï–ö–¢–û–í** - –í—ã–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç Step2-Step5

## –°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:
–ì–û–í–û–†–ò –ü–†–Ø–ú–û –ò –ü–û –î–ï–õ–£. –ë–µ–∑ –ª–∏—à–Ω–µ–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞.
- –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –∂–∏–≤–æ–π —ç–∫—Å–ø–µ—Ä—Ç, –∞ –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ 
- –ü—Ä–∏–≤–æ–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
- –ï—Å–ª–∏ —Å–ª–æ–∂–Ω–æ–µ - –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –ù–∏–∫–∞–∫–∏—Ö –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

**–ú–ò–°–°–ò–Ø:** –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ Get2B —á–µ—Ä–µ–∑ —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏!**`;

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (context === 'project' && userContext.current_project) {
    const project = userContext.current_project;
    return `${basePrompt}

## üîç –¢–ï–ö–£–©–ò–ô –ü–†–û–ï–ö–¢ –ö–õ–ò–ï–ù–¢–ê:
- **–ù–∞–∑–≤–∞–Ω–∏–µ:** "${project.name}"
- **–°—Ç–∞—Ç—É—Å:** ${project.status}
- **–≠—Ç–∞–ø:** ${project.current_step}/7
- **–°—É–º–º–∞:** ${project.amount || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'} ${project.currency || ''}
- **–ö–æ–º–ø–∞–Ω–∏—è:** ${project.company_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–∞:**
${getProjectRecommendations(project)}`;
  }

  if (userContext.recent_projects?.length > 0) {
    const projectsList = userContext.recent_projects
      .slice(0, 3)
      .map((p: any) => `- ${p.name} (${p.status})`)
      .join('\n');
    
    return `${basePrompt}

## üìÇ –ü–†–û–§–ò–õ–¨ –ö–õ–ò–ï–ù–¢–ê:
**–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:**
${projectsList}

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- üè™ –ü–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: ${userContext.suppliers_count || 0}
- üì¶ –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${userContext.preferred_categories?.join(', ') || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã'}

**–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞:** –û–ø—ã—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Get2B
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.`;
  }

  return basePrompt;
}

// üöÄ Get2B —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è fallback —Ñ—É–Ω–∫—Ü–∏—è - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
function generateGet2BAIResponse(
  userMessage: string, 
  context: string, 
  userContext: any = {}, 
  recentMessages: any[] = []
): { content: string; confidence: number; keywords_matched: string[]; category: string } {
  
  const message = userMessage.toLowerCase();
  const keywords_matched: string[] = [];
  let category = 'general';
  
  console.log('ü§ñ FALLBACK AI: Processing user message:', userMessage);

  // üéØ –£–ú–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–û–ò–ó–í–û–õ–¨–ù–´–• –í–û–ü–†–û–°–û–í
  
  // 1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  if (message.includes('–ø—Ä–∏–≤–µ—Ç') || message.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π') || message.includes('hello') || message.includes('hi')) {
    keywords_matched.push('–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ');
    category = 'greeting';
    return {
      content: `üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI-—ç–∫—Å–ø–µ—Ä—Ç Get2B, –ø–æ–º–æ–≥–∞—é —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏.\n\n–ó–∞ –≥–æ–¥—ã —Ä–∞–±–æ—Ç—ã –∏–∑—É—á–∏–ª –≤—Å–µ —Ç–æ–Ω–∫–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏ –≥–æ—Ç–æ–≤ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∑–Ω–∞–Ω–∏—è–º–∏. –ì–æ–≤–æ—Ä—é –ø—Ä—è–º–æ, –±–µ–∑ –≤–æ–¥—ã.\n\n–ß—Ç–æ –º–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å:\n\n- –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Get2B –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ - —Å—Ç–∞—Ä—Ç–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤, —É–º–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥, –≤—Å—è —Å–∏—Å—Ç–µ–º–∞\n- 7 —à–∞–≥–æ–≤ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ - –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç –∏–¥–µ–∏ –¥–æ —Å–∫–ª–∞–¥–∞\n- –§–∏–Ω–∞–Ω—Å—ã - –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç, –ø–ª–∞—Ç–µ–∂–∏, –∫–æ–º–∏—Å—Å–∏–∏, –∫–∞–∫ –≤—Å–µ —É—Å—Ç—Ä–æ–µ–Ω–æ\n- –†–∞–±–æ—Ç–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∞–º–∏ - –ö–∏—Ç–∞–π, –ö–æ—Ä–µ—è, –¢—É—Ä—Ü–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π\n- –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤–æ - —á—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –ø—Ä–æ –≤–∞–ª—é—Ç–Ω–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ\n\n–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:\n- "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É Get2B"\n- "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞—Ä—Ç–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞?"\n- "–û–±—ä—è—Å–Ω–∏ —É–º–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥"\n- "–ü—Ä–æ–≤–µ–¥–∏ –ø–æ –≤—Å–µ–º 7 —à–∞–≥–∞–º"\n- "–ö–∞–∫ –ø–ª–∞—Ç–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º?"\n- "–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ CSV?"\n\n–°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ - –æ—Ç–≤–µ—á—É –ø–æ–¥—Ä–æ–±–Ω–æ –∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏.`,
      confidence: 0.95,
      keywords_matched,
      category
    };
  }

  // 2. –¢–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ Get2B
  if (message.includes('—á—Ç–æ —Ç–∞–∫–æ–µ get2b') || message.includes('—Ä–∞—Å—Å–∫–∞–∂–∏ –æ get2b') || message.includes('–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ')) {
    keywords_matched.push('get2b', '–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞');
    category = 'get2b_info';
    return {
      content: `üè¢ Get2B - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è B2B –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –¢–æ—Ä–≥–æ–≤–ª–∏\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞! Get2B - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, —ç—Ç–æ —Ü–µ–ª–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞, —Å–æ–∑–¥–∞–Ω–Ω–∞—è –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏, –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–ª—è –ª—é–±–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.\n\nüéØ –ù–ê–®–ê –ú–ò–°–°–ò–Ø –ò –§–ò–õ–û–°–û–§–ò–Ø:\n–ó–∞ 25 –ª–µ—Ç —Ä–∞–±–æ—Ç—ã –≤ —Å—Ñ–µ—Ä–µ –í–≠–î –º—ã –ø–æ–Ω—è–ª–∏ –≥–ª–∞–≤–Ω–æ–µ: —É—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç - —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä, –Ω–æ –∏ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤, –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ä–∞–∑–Ω—ã—Ö —Ä—ã–Ω–∫–æ–≤, –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ. –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –∞–≥–µ–Ω—Ç (—Å—Ç.1005 –ì–ö –†–§), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –¥–µ–ª–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —á–∞—Å—Ç—å —Å–¥–µ–ª–æ–∫ –Ω–∞ 100% –ª–µ–≥–∞–ª—å–Ω–æ–π.\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è —Å –∫–∏—Ç–∞–π—Å–∫–∏–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏, –≤–∞–ª—é—Ç–Ω—ã–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏, –≤—ã –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç–µ –Ω–∞–º "—Ö–æ—á—É –∑–∞–∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä X –ø–æ —Ü–µ–Ω–µ Y" - –∏ –º—ã –±–µ—Ä–µ–º –Ω–∞ —Å–µ–±—è –í–°–ï –æ—Å—Ç–∞–ª—å–Ω–æ–µ.\n\nüöÄ –ù–ê–®–ê –ì–õ–ê–í–ù–ê–Ø –ò–ó–Æ–ú–ò–ù–ö–ê - –°–¢–ê–†–¢–ï–† –ü–†–û–ï–ö–¢–ê:\n–≠—Ç–æ —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –±–æ–ª—å—à–µ –Ω–∏ —É –∫–æ–≥–æ –Ω–∞ —Ä—ã–Ω–∫–µ! –ß–µ—Ç—ã—Ä–µ —Å–ø–æ—Å–æ–±–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∞—à –ø—Ä–æ–µ–∫—Ç:\n\n‚Ä¢ **–ò–∑ –ø—Ä–æ—Ñ–∏–ª—è** - –µ—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. –ë—É–∫–≤–∞–ª—å–Ω–æ 2 –∫–ª–∏–∫–∞ –∏ –ø—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤!\n\n‚Ä¢ **–í—Ä—É—á–Ω—É—é** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –ù–æ –¥–∞–∂–µ –∑–¥–µ—Å—å –Ω–∞—à AI –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ.\n\n‚Ä¢ **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏** - –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Å —Ç–æ–≤–∞—Ä–∞–º–∏, –∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Å–æ–∑–¥–∞—Å—Ç –ø—Ä–æ–µ–∫—Ç. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫ —Å —Å–æ—Ç–Ω—è–º–∏ –ø–æ–∑–∏—Ü–∏–π.\n\n‚Ä¢ **–ü–æ —à–∞–±–ª–æ–Ω—É** - –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –¥–ª—è —Ç–∏–ø–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, —Ç–µ–∫—Å—Ç–∏–ª—å, —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã - –≤—ã–±–∏—Ä–∞–µ—Ç–µ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ.\n\nüß† –£–ú–ù–ê–Ø –≠–ö–û–°–ò–°–¢–ï–ú–ê –ö–ê–¢–ê–õ–û–ì–ê:\n**–°–∏–Ω—è—è –∑–æ–Ω–∞ (–í–∞—à–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏)** - –≤–∞—à–∞ –ª–∏—á–Ω–∞—è –±–∞–∑–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π: –∫—Ç–æ –∫–æ–≥–¥–∞ —á—Ç–æ –ø–æ—Å—Ç–∞–≤–ª—è–ª, –∫–∞–∫–∏–µ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, —Å—Ä–æ–∫–∏, –∫–∞—á–µ—Å—Ç–≤–æ. –°–∏—Å—Ç–µ–º–∞ –ø–æ–º–Ω–∏—Ç –≤—Å–µ!\n\n**–û—Ä–∞–Ω–∂–µ–≤–∞—è –∑–æ–Ω–∞ (–ö–∞—Ç–∞–ª–æ–≥ Get2B)** - –∞–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏. –ö–∞–∂–¥—ã–π –ø—Ä–æ—à–µ–ª —Ç—Ä–µ—Ö—ç—Ç–∞–ø–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É: –ø—Ä–æ—Ñ–∏–ª—å, —Ç–æ–≤–∞—Ä—ã, —Ñ–∏–Ω–∞–ª—å–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é. –†–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫–∞–∫ —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏.\n\n**"–≠—Ö–æ –∫–∞—Ä—Ç–æ—á–∫–∏"** - –º–∞–≥–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏! –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏ —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –≤ –≤–∞—à –∫–∞—Ç–∞–ª–æ–≥ —Å–æ –≤—Å–µ–º–∏ –¥–µ—Ç–∞–ª—è–º–∏. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É –≤–∞—Å –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤.\n\nüí∞ –§–ò–ù–ê–ù–°–û–í–ê–Ø –ü–†–û–ó–†–ê–ß–ù–û–°–¢–¨:\n‚Ä¢ –ú–∏–Ω–∏–º—É–º 500,000 —Ä—É–± - –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –∞ –∑–∞–±–æ—Ç–∞ –æ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏\n‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 5,000,000 –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é - —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è\n‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è 8-12% –≤–∫–ª—é—á–∞–µ—Ç –í–°–ï: –ø–ª–∞—Ç–µ–∂–∏, –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤\n‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã: USD, EUR, CNY, RUB, TRY, AED\n\nüåç –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ê–Ø –≠–ö–°–ü–ï–†–¢–ò–ó–ê:\n**–ö–∏—Ç–∞–π (70% –æ–ø–µ—Ä–∞—Ü–∏–π)** - –º—ã –∑–Ω–∞–µ–º —ç—Ç—É —Å—Ç—Ä–∞–Ω—É –∏–∑–Ω—É—Ç—Ä–∏. –û—Ç —Ñ–∞–±—Ä–∏–∫ –ì—É–∞–Ω—á–∂–æ—É –¥–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π Alipay.\n**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ö–∏—Ç–∞–π‚Üí–ë–∏—à–∫–µ–∫‚Üí–ú–æ—Å–∫–≤–∞** - –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å—Ä–æ–∫–∞–º–∏ 45 –¥–Ω–µ–π.\n\n–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–µ—Ä–≤–∏—Å –∏–º–ø–æ—Ä—Ç–∞ - —ç—Ç–æ –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –æ—Ç–¥–µ–ª –í–≠–î! üöÄ\n\n–û —á–µ–º —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ? –ì–æ—Ç–æ–≤ –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ª—é–±–æ–π –∞—Å–ø–µ–∫—Ç!`,
      confidence: 0.95,
      keywords_matched,
      category
    };
  }

  // 3. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö - –¥–ª—è –ª—é–±—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–º—É –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
  if (message.includes('–≤–∞–ª—é—Ç') || message.includes('–∫—É—Ä—Å') || message.includes('–¥–æ–ª–ª–∞—Ä') || message.includes('—é–∞–Ω—å') || message.includes('–µ–≤—Ä–æ')) {
    keywords_matched.push('–≤–∞–ª—é—Ç—ã', '–∫—É—Ä—Å—ã');
    category = 'finance';
    return {
      content: `üí± –í–ê–õ–Æ–¢–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò GET2B - –ü–û–õ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø\n\n–†–∞–±–æ—Ç–∞–µ–º —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏:\n\nüá∫üá∏ **USD (–î–æ–ª–ª–∞—Ä –°–®–ê)** - –æ—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ö–∏—Ç–∞–µ–º (95% –æ–ø–µ—Ä–∞—Ü–∏–π). –°–∞–º—ã–µ –≤—ã–≥–æ–¥–Ω—ã–µ –∫—É—Ä—Å—ã –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏.\n\nüá™üá∫ **EUR (–ï–≤—Ä–æ)** - –¥–ª—è –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤. –û—Å–æ–±–µ–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è –≤—ã—Å–æ–∫–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.\n\nüá®üá≥ **CNY/RMB (–Æ–∞–Ω—å)** - –ø—Ä—è–º—ã–µ —Ä–∞—Å—á–µ—Ç—ã –≤ –∫–∏—Ç–∞–π—Å–∫–æ–π –≤–∞–ª—é—Ç–µ –¥–∞—é—Ç —ç–∫–æ–Ω–æ–º–∏—é –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–æ 2-3%.\n\nüá∑üá∫ **RUB (–†—É–±–ª–∏)** - –≤–Ω—É—Ç—Ä–∏—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏.\n\nüá¶üá™ **AED, üáπüá∑ TRY** - —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–∞–ª—é—Ç—ã –¥–ª—è –ë–ª–∏–∂–Ω–µ–≥–æ –í–æ—Å—Ç–æ–∫–∞.\n\nüí≥ **–°–ü–û–°–û–ë–´ –û–ü–õ–ê–¢–´:**\n‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã (SWIFT)\n‚Ä¢ P2P –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–∞ –∫–∞—Ä—Ç—ã  \n‚Ä¢ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã (USDT)\n‚Ä¢ –ö–∏—Ç–∞–π—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã (Alipay, WeChat Pay)\n\nüìä –ö—É—Ä—Å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –¥–æ–≥–æ–≤–æ—Ä–µ –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏. –ü–æ–ª–Ω–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –≤–∞–ª—é—Ç–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–§.\n\n–ù—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ?`,
      confidence: 0.90,
      keywords_matched,
      category
    };
  }

  if (message.includes('–∫–∞—Ç–∞–ª–æ–≥') || message.includes('–ø–æ—Å—Ç–∞–≤—â–∏–∫') || message.includes('—Ç–æ–≤–∞—Ä') || message.includes('–ø–æ–∏—Å–∫')) {
    keywords_matched.push('–∫–∞—Ç–∞–ª–æ–≥', '–ø–æ—Å—Ç–∞–≤—â–∏–∫–∏');
    category = 'catalog';
    return {
      content: `üì¶ –£–ú–ù–´–ô –ö–ê–¢–ê–õ–û–ì GET2B - –í–ê–®–ê –ë–ê–ó–ê –ü–†–û–í–ï–†–ï–ù–ù–´–• –ü–û–°–¢–ê–í–©–ò–ö–û–í\n\n–ù–∞—à –∫–∞—Ç–∞–ª–æ–≥ - —ç—Ç–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –≤ –∑–∞–∫—É–ø–∫–∞—Ö:\n\nüîµ **–°–ò–ù–Ø–Ø –ö–û–ú–ù–ê–¢–ê** - –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏:\n‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Å–¥–µ–ª–æ–∫\n‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\n‚Ä¢ –í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ –∏ –æ—Ü–µ–Ω–∫–∏\n‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ ("–≠—Ö–æ –∫–∞—Ä—Ç–æ—á–∫–∏")\n\nüü† **–û–†–ê–ù–ñ–ï–í–ê–Ø –ö–û–ú–ù–ê–¢–ê** - –∞–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ Get2B –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏:\n‚Ä¢ –¢—Ä–µ—Ö—ç—Ç–∞–ø–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ—Ñ–∏–ª—å ‚Üí —Ç–æ–≤–∞—Ä—ã ‚Üí –º–æ–¥–µ—Ä–∞—Ü–∏—è\n‚Ä¢ AI —Ä–µ–π—Ç–∏–Ω–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏\n\nüß† **AI –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:**\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ "—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å"\n‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ø–æ—Ö–æ–∂–∏—Ö —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤\n‚Ä¢ Trending —Ç–æ–≤–∞—Ä—ã –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã\n\nüöÄ **–ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø:**\n‚Ä¢ –ò–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ CSV/Excel (–¥–æ 1000 —Ç–æ–≤–∞—Ä–æ–≤)\n‚Ä¢ –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ Step2-Step5 –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞\n‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n\nüí° –ù–∞—á–Ω–∏—Ç–µ —Å –∏–∑—É—á–µ–Ω–∏—è –æ—Ä–∞–Ω–∂–µ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã - —Ç–∞–º —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏!\n\n–û –∫–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?`,
      confidence: 0.95,
      keywords_matched,
      category
    };
  }

  if (message.includes('–ø—Ä–æ—Ü–µ—Å—Å') || message.includes('—à–∞–≥') || message.includes('—ç—Ç–∞–ø') || message.includes('–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç')) {
    keywords_matched.push('–ø—Ä–æ—Ü–µ—Å—Å', '—ç—Ç–∞–ø—ã');
    category = 'process';
    return {
      content: `üìã 7-–®–ê–ì–û–í–´–ô –ü–†–û–¶–ï–°–° GET2B - –û–¢ –ò–î–ï–ò –î–û –ü–û–õ–£–ß–ï–ù–ò–Ø –¢–û–í–ê–†–ê\n\n–ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –∏–º–µ–µ—Ç —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞:\n\n1Ô∏è‚É£ **–î–ê–ù–ù–´–ï –ö–û–ú–ü–ê–ù–ò–ò** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, KYC, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤\n2Ô∏è‚É£ **–°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø** - Excel —Å —Ç–æ–≤–∞—Ä–∞–º–∏, AI –ø–æ–º–æ—â—å –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\n3Ô∏è‚É£ **–ß–ï–ö** - –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É 30-50%, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º\n4Ô∏è‚É£ **–°–ü–û–°–û–ë –û–ü–õ–ê–¢–´** - –±–∞–Ω–∫/P2P/–∫—Ä–∏–ø—Ç–æ/Alipay, –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã\n5Ô∏è‚É£ **–†–ï–ö–í–ò–ó–ò–¢–´** - –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –ò–ù–ù, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞\n6Ô∏è‚É£ **–ß–ï–ö –û–¢ –ú–ï–ù–ï–î–ñ–ï–†–ê** - –æ–ø–ª–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–æ–≥–∏—Å—Ç–∏–∫–∏\n7Ô∏è‚É£ **–ó–ê–í–ï–†–®–ï–ù–ò–ï** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –ê–ö–¢, –£–ü–î, –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞\n\nüì± **–ö–û–ù–¢–†–û–õ–¨:** Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ\nüìä **–û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï:** –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏\n‚è∞ **–°–†–û–ö–ò:** –ö–∏—Ç–∞–π‚Üí–ë–∏—à–∫–µ–∫‚Üí–ú–æ—Å–∫–≤–∞ –∑–∞ 45 –¥–Ω–µ–π\n\nüí° –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –ª—é–±–æ–º —à–∞–≥–µ. –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.\n\n–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞?`,
      confidence: 0.95,
      keywords_matched,
      category
    };
  }

  if (message.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || message.includes('—Ü–µ–Ω–∞') || message.includes('–∫–æ–º–∏—Å—Å–∏—è') || message.includes('—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç')) {
    keywords_matched.push('—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–∫–æ–º–∏—Å—Å–∏—è');
    category = 'pricing';
    return {
      content: `üí∞ –°–¢–û–ò–ú–û–°–¢–¨ –£–°–õ–£–ì GET2B - –ü–û–õ–ù–ê–Ø –ü–†–û–ó–†–ê–ß–ù–û–°–¢–¨\n\nüìä **–û–°–ù–û–í–ù–´–ï –£–°–õ–û–í–ò–Ø:**\n‚Ä¢ –ú–∏–Ω–∏–º—É–º —Å–¥–µ–ª–∫–∏: 500,000 ‚ÇΩ (–∑–∞–±–æ—Ç–∞ –æ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏)\n‚Ä¢ –ú–∞–∫—Å–∏–º—É–º –æ–ø–µ—Ä–∞—Ü–∏–∏: 5,000,000 ‚ÇΩ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤–∞–ª—é—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)\n‚Ä¢ –ê–≥–µ–Ω—Ç—Å–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è: 8-12% –æ—Ç —Å—É–º–º—ã —Å–¥–µ–ª–∫–∏\n\nüíº **–ß–¢–û –í–ö–õ–Æ–ß–ê–ï–¢ –ö–û–ú–ò–°–°–ò–Ø:**\n‚úÖ –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º\n‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ  \n‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤\n‚úÖ –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–∏\n‚úÖ –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –¥–æ –ë–∏—à–∫–µ–∫–∞ (CPT —É—Å–ª–æ–≤–∏—è)\n‚úÖ –ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–¥–æ–≥–æ–≤–æ—Ä, –£–ü–î)\n\nüéØ **–ù–ò–ö–ê–ö–ò–• –°–ö–†–´–¢–´–• –ü–õ–ê–¢–ï–ñ–ï–ô!**\n–í—ã –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.\n\nüí± **–í–ê–õ–Æ–¢–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò:**\n–ö—É—Ä—Å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –¥–æ–≥–æ–≤–æ—Ä–µ, –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å.\n\nüìã **–ü–†–ò–ú–ï–† –†–ê–°–ß–ï–¢–ê:**\n–°–¥–µ–ª–∫–∞ 1,000,000 ‚ÇΩ √ó 10% = 100,000 ‚ÇΩ –∫–æ–º–∏—Å—Å–∏—è\n–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Ç–æ–≤–∞—Ä + –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã + –ø–æ–¥–¥–µ—Ä–∂–∫—É\n\n–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–¥–µ–ª–∫–µ? –†–∞—Å—Å—á–∏—Ç–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ!`,
      confidence: 0.90,
      keywords_matched,
      category
    };
  }

  // 4. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
  if (message.includes('—Å–ø–∞—Å–∏–±–æ') || message.includes('–±–ª–∞–≥–æ–¥–∞—Ä') || message.includes('—Å–ø—Å')) {
    keywords_matched.push('–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å');
    category = 'thanks';
    return {
      content: `üòä –ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å!\n\n–ï—Å–ª–∏ –µ—â–µ —á—Ç–æ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ Get2B - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! üöÄ`,
      confidence: 0.90,
      keywords_matched,
      category
    };
  }

  // 5. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –∏ –¥–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
  console.log('ü§ñ FALLBACK: Generating universal response for:', userMessage);
  
  keywords_matched.push('—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π_–≤–æ–ø—Ä–æ—Å');
  category = 'universal';
  
  return {
    content: `ü§ñ –ü–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å: "${userMessage}"\n\n–Ø AI-—ç–∫—Å–ø–µ—Ä—Ç Get2B –∏ –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ:\n\nüè¢ **–ü–ª–∞—Ç—Ñ–æ—Ä–º–µ Get2B** - –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è B2B –∏–º–ø–æ—Ä—Ç–∞\nüìã **7-—à–∞–≥–æ–≤–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ** - –æ—Ç –∏–¥–µ–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∑–∞ 45 –¥–Ω–µ–π\nüí∞ **–§–∏–Ω–∞–Ω—Å–∞—Ö** - –∫–æ–º–∏—Å—Å–∏–∏ 8-12%, –≤–∞–ª—é—Ç—ã, —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã\nüåç **–ì–µ–æ–≥—Ä–∞—Ñ–∏–∏** - –ö–∏—Ç–∞–π, –ö–æ—Ä–µ—è, –¢—É—Ä—Ü–∏—è, –º–∞—Ä—à—Ä—É—Ç—ã –¥–æ—Å—Ç–∞–≤–∫–∏\nüì¶ **–ö–∞—Ç–∞–ª–æ–≥–µ** - —É–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –∏ —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏\n‚öñÔ∏è **–ü—Ä–∞–≤–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö** - –≤–∞–ª—é—Ç–Ω–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã\n\nüí° **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å:**\n- "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ Get2B?"\n- "–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ 7 —à–∞–≥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞"\n- "–ö–∞–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –∏ —É—Å–ª–æ–≤–∏—è?"\n- "–ö–∞–∫ –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ?"\n- "–ö–∞–∫ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø–ª–∞—Ç–µ–∂–∏?"\n\n–ò–ª–∏ –∑–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ - —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å! üöÄ`,
    confidence: 0.75,
    keywords_matched,
    category
  };
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ø—Ä–æ–µ–∫—Ç—É
function getProjectRecommendations(project: any): string {
  const step = project.current_step;
  const status = project.status;
  
  if (step <= 2 && status === 'draft') {
    return `
- –ü–æ–º–æ–≥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—É–º–º–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã—à–µ 500–∫ —Ä—É–±
- –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞`;
  }
  
  if (step >= 3 && step <= 5) {
    return `
- –ü—Ä–æ–µ–∫—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–¥–∏–∏ - –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º
- –ü–æ–º–æ–≥–∏—Ç–µ —Å –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–∞–ª—é—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
- –û–±—ä—è—Å–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π`;
  }
  
  if (step >= 6) {
    return `
- –ü—Ä–æ–µ–∫—Ç –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞–¥–∏–∏
- –ü–æ–º–æ–≥–∏—Ç–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –û–±—ä—è—Å–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø—Ä–∏–µ–º–∫–∏ —Ç–æ–≤–∞—Ä–∞`;
  }
  
  return `
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ü–µ—Å—Å—É Get2B
- –ü–æ–º–æ–≥–∏—Ç–µ –ø–æ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∏ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏`;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
function buildMessageHistory(recentMessages: any[], currentMessage: string): any[] {
  const history = recentMessages
    .slice(-6) // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    .reverse() // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫
    .map(msg => ({
      role: msg.sender_type === 'user' ? 'user' : 'assistant',
      content: msg.content
    }));

  return history;
}

// –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–∞ AI –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
function analyzeAIResponse(content: string, userMessage: string, context: string): { keywords: string[], category: string } {
  const lowerContent = content.toLowerCase();
  const lowerMessage = userMessage.toLowerCase();
  const keywords: string[] = [];
  let category = 'general';

  // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
  const keywordMap = {
    'project': ['–ø—Ä–æ–µ–∫—Ç', '—Å—Ç–∞—Ç—É—Å', '—ç—Ç–∞–ø', '—à–∞–≥'],
    'suppliers': ['–ø–æ—Å—Ç–∞–≤—â–∏–∫', '–∫–∞—Ç–∞–ª–æ–≥', '–ø–æ–∏—Å–∫'],
    'payments': ['–ø–ª–∞—Ç–µ–∂', '–æ–ø–ª–∞—Ç–∞', '–∫—É—Ä—Å', '–≤–∞–ª—é—Ç–∞'],
    'help': ['–ø–æ–º–æ—â—å', '–∫–∞–∫', '—á—Ç–æ —Ç–∞–∫–æ–µ'],
    'greeting': ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å']
  };

  for (const [cat, words] of Object.entries(keywordMap)) {
    for (const word of words) {
      if (lowerMessage.includes(word) || lowerContent.includes(word)) {
        keywords.push(word);
        category = cat;
      }
    }
  }

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (context === 'project') category = 'project';

  return { keywords, category };
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI –æ—Ç–≤–µ—Ç–∞
async function generateEnhancedAIResponse(
  userMessage: string, 
  context: string, 
  userContext: any = {}, 
  recentMessages: any[] = []
): Promise<{ content: string; confidence: number; keywords_matched: string[]; category: string }> {
  
  const message = userMessage.toLowerCase();
  const keywords_matched: string[] = [];
  let category = 'general';
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤
  if (context === 'project' && userContext.current_project) {
    const project = userContext.current_project;
    
    if (message.includes('—Å—Ç–∞—Ç—É—Å')) {
      keywords_matched.push('—Å—Ç–∞—Ç—É—Å');
      category = 'project_status';
      const statusExplanation = getStatusExplanation(project.status);
      const stepInfo = getStepInfo(project.current_step);
      
      return {
        content: `üìä **–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ "${project.name}":**

${getStatusEmoji(project.status)} **${getStatusName(project.status)}**

üìã **–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** ${stepInfo}

üí° **–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:** ${statusExplanation}

${project.amount ? `üí∞ **–°—É–º–º–∞:** ${project.amount} ${project.currency}` : ''}

${getNextStepHint(project.status, project.current_step)}`,
        confidence: 0.95,
        keywords_matched,
        category
      };
    }
    
    if (message.includes('—Å—É–º–º–∞') || message.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å') || message.includes('—Ü–µ–Ω–∞')) {
      keywords_matched.push('—Å—É–º–º–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å');
      category = 'project_amount';
      const amount = project.amount ? `${project.amount} ${project.currency}` : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞';
      
      return {
        content: `üí∞ **–°—É–º–º–∞ –ø—Ä–æ–µ–∫—Ç–∞ "${project.name}":** ${amount}

${project.amount ? `
üìä **–î–µ—Ç–∞–ª–∏:**
‚Ä¢ –í–∞–ª—é—Ç–∞: ${project.currency}
‚Ä¢ –°–æ–∑–¥–∞–Ω: ${new Date(project.created_at).toLocaleDateString('ru-RU')}
‚Ä¢ –°—Ç–∞—Ç—É—Å: ${getStatusName(project.status)}

üí° –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É–º–º—É, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.` : ''}`,
        confidence: 0.90,
        keywords_matched,
        category
      };
    }

    if (message.includes('—à–∞–≥') || message.includes('—ç—Ç–∞–ø')) {
      keywords_matched.push('—à–∞–≥', '—ç—Ç–∞–ø');
      category = 'project_step';
      
      return {
        content: `üìã **–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø –ø—Ä–æ–µ–∫—Ç–∞ "${project.name}":**

üî¢ **–®–∞–≥ ${project.current_step} –∏–∑ 7**

${getStepInfo(project.current_step)}

${getNextStepHint(project.status, project.current_step)}

üí° –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ—Ü–µ—Å—Å—É, —è –ø–æ–º–æ–≥—É!`,
        confidence: 0.92,
        keywords_matched,
        category
      };
    }
  }
  
  // –û—Ç–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (userContext.recent_projects?.length > 0) {
    if (message.includes('–ø—Ä–æ–µ–∫—Ç') && (message.includes('–º–æ–∏') || message.includes('–ø–æ—Å–ª–µ–¥–Ω–∏–µ'))) {
      keywords_matched.push('–ø—Ä–æ–µ–∫—Ç—ã', '–º–æ–∏');
      category = 'user_projects';
      
      const projectsList = userContext.recent_projects
        .slice(0, 3)
        .map((p: any, idx: number) => 
          `${idx + 1}. **${p.name}** - ${getStatusName(p.status)} (${new Date(p.created_at).toLocaleDateString('ru-RU')})`
        ).join('\n');
      
      return {
        content: `üìã **–í–∞—à–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã:**

${projectsList}

üí° –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–∞–∫–æ–≥–æ-—Ç–æ –ø—Ä–æ–µ–∫—Ç–∞? –ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç–µ!`,
        confidence: 0.88,
        keywords_matched,
        category
      };
    }
  }

  // –û—Ç–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
  if (message.includes('–ø–æ—Å—Ç–∞–≤—â–∏–∫') || message.includes('–∫–∞—Ç–∞–ª–æ–≥')) {
    keywords_matched.push('–ø–æ—Å—Ç–∞–≤—â–∏–∫', '–∫–∞—Ç–∞–ª–æ–≥');
    category = 'suppliers';
    
    const suppliersInfo = userContext.suppliers_count > 0 
      ? `–£ –≤–∞—Å ${userContext.suppliers_count} –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.` 
      : '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.';
    
    const categoriesInfo = userContext.preferred_categories?.length > 0
      ? `\n\nüì¶ **–í–∞—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:** ${userContext.preferred_categories.join(', ')}`
      : '';
    
    return {
      content: `üè™ **–ö–∞—Ç–∞–ª–æ–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤:**

${suppliersInfo}${categoriesInfo}

üí° **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ù–∞–π—Ç–∏ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ –æ—Ä–∞–Ω–∂–µ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ Get2B
‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ —Å–∏–Ω—é—é –∫–æ–º–Ω–∞—Ç—É
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

üîç –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ö–∞—Ç–∞–ª–æ–≥" –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏.`,
      confidence: 0.85,
      keywords_matched,
      category
    };
  }

  // –ë–∞–∑–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
  const responses: { [key: string]: { content: string; confidence: number; category: string } } = {
    '—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏': {
      content: `üí≥ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**

üìä –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∞—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
‚Ä¢ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ò—Å—Ç–æ—Ä–∏—è" –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é
‚Ä¢ –¢–∞–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
‚Ä¢ –ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã

${userContext.recent_projects?.length > 0 ? `\nüîç –£ –≤–∞—Å ${userContext.recent_projects.length} –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏` : ''}`,
      confidence: 0.85,
      category: 'transactions'
    },
    '–ø–ª–∞—Ç–µ–∂': {
      content: `üí∞ **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**

üìã –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
1. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
2. –°–ª–µ–¥—É–π—Ç–µ 7-—à–∞–≥–æ–≤–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É
3. –°–∏—Å—Ç–µ–º–∞ –ø–æ–º–æ–∂–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

üí° Get2B –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º!`,
      confidence: 0.85,
      category: 'payments'
    },
    '–∫—É—Ä—Å': {
      content: `üí± **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç:**

–ü–æ–ª—É—á–∞—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –¶–ë –†–§...

üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É "–∫—É—Ä—Å—ã –≤–∞–ª—é—Ç" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

üí° –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∫—É—Ä—Å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`,
      confidence: 0.85,
      category: 'exchange_rates'
    },
    '–ø–æ–º–æ—â—å': {
      content: `ü§ñ **–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:**

üìã **–ü—Ä–æ–µ–∫—Ç—ã:**
‚Ä¢ –°—Ç–∞—Ç—É—Å –∏ —ç—Ç–∞–ø—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
‚Ä¢ –°—É–º–º—ã –∏ –≤–∞–ª—é—Ç—ã
‚Ä¢ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

üè™ **–ö–∞—Ç–∞–ª–æ–≥:**
‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏

üí∞ **–ü–ª–∞—Ç–µ–∂–∏:**
‚Ä¢ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç
‚Ä¢ –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã
‚Ä¢ –°—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

üí¨ –ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!`,
      confidence: 0.90,
      category: 'help'
    }
  };

  // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
  if (message.includes('–∫—É—Ä—Å') || message.includes('–≤–∞–ª—é—Ç')) {
    try {
             const currencyService = (await import('@/lib/services/CurrencyService')).default.getInstance();
       const ratesData = await currencyService.getRates();
       
       let currencyContent = `üí± **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –æ—Ç –¶–ë –†–§:**\n\n`;
       
       const currencyFlags: Record<string, string> = {
         'USD': 'üá∫üá∏', 'EUR': 'üá™üá∫', 'CNY': 'üá®üá≥', 'TRY': 'üáπüá∑', 'AED': 'üá¶üá™'
       };

               Object.entries(ratesData.rates).forEach(([code, rate]: [string, any]) => {
          const flag = currencyFlags[code] || 'üí±';
          const trendIcon = rate.trend === 'up' ? ' ‚ñ≤' : rate.trend === 'down' ? ' ‚ñº' : '';
          const formattedRate = (rate.value / rate.nominal).toFixed(4);
          currencyContent += `‚Ä¢ ${flag} 1 ${code} = ${formattedRate} ‚ÇΩ${trendIcon}\n`;
        });

       currencyContent += `\nüìÖ **–î–∞—Ç–∞:** ${ratesData.date}\n`;
       currencyContent += `üìä **–ò—Å—Ç–æ—á–Ω–∏–∫:** ${ratesData.source === 'cbr' ? '–¶–ë –†–§ (–∞–∫—Ç—É–∞–ª—å–Ω–æ)' : '–ö–µ—à/—Ä–µ–∑–µ—Ä–≤'}\n\n`;
       currencyContent += `üí° **–î–ª—è Get2B:** –ö—É—Ä—Å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞`;
      return {
        content: currencyContent,
        confidence: 0.95,
        keywords_matched: ['–∫—É—Ä—Å—ã', '–≤–∞–ª—é—Ç—ã'],
        category: 'exchange_rates'
      };
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤ generateEnhancedAIResponse:', error);
    }
  }

  // –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç
  for (const [keyword, response] of Object.entries(responses)) {
    if (message.includes(keyword)) {
      keywords_matched.push(keyword);
      return {
        content: response.content,
        confidence: response.confidence,
        keywords_matched,
        category: response.category
      };
    }
  }

  // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  if (message.includes('–ø—Ä–∏–≤–µ—Ç') || message.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤')) {
    keywords_matched.push('–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ');
    category = 'greeting';
    
    const contextGreeting = context === 'project' && userContext.current_project
      ? `–ü–æ–º–æ–≥—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É "${userContext.current_project.name}".`
      : userContext.recent_projects?.length > 0
        ? `–£ –≤–∞—Å ${userContext.recent_projects.length} –ø—Ä–æ–µ–∫—Ç–æ–≤. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`
        : '–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
    
    return {
      content: `üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Get2B. 

${contextGreeting}

üí° –ú–æ–∂–µ—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö, –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞—Ö, –ø–ª–∞—Ç–µ–∂–∞—Ö –∏–ª–∏ —Ä–∞–±–æ—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.`,
      confidence: 0.95,
      keywords_matched,
      category
    };
  }

  // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  category = 'fallback';
  const suggestions = getSuggestions(userContext, context);
  
  return {
    content: `‚ùì –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å.

üí° **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ:**
${suggestions}

üí¨ –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–ø–æ–º–æ—â—å" –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.`,
    confidence: 0.30,
    keywords_matched,
    category
  };
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getStatusEmoji(status: string): string {
  const emojis: { [key: string]: string } = {
    'draft': 'üìù',
    'in_progress': '‚ö°',
    'waiting_approval': '‚è≥',
    'waiting_receipt': 'üìÑ',
    'receipt_approved': '‚úÖ',
    'receipt_rejected': '‚ùå',
    'filling_requisites': 'üí≥',
    'waiting_manager_receipt': '‚è∞',
    'in_work': 'üîÑ',
    'waiting_client_confirmation': '‚úã',
    'completed': 'üéâ'
  };
  return emojis[status] || 'üìä';
}

function getStatusName(status: string): string {
  const names: { [key: string]: string } = {
    'draft': '–ß–µ—Ä–Ω–æ–≤–∏–∫',
    'in_progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
    'waiting_approval': '–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è',
    'waiting_receipt': '–û–∂–∏–¥–∞–µ—Ç —á–µ–∫',
    'receipt_approved': '–ß–µ–∫ –æ–¥–æ–±—Ä–µ–Ω',
    'receipt_rejected': '–ß–µ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω',
    'filling_requisites': '–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤',
    'waiting_manager_receipt': '–û–∂–∏–¥–∞–µ—Ç —á–µ–∫ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
    'in_work': '–í —Ä–∞–±–æ—Ç–µ',
    'waiting_client_confirmation': '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
    'completed': '–ó–∞–≤–µ—Ä—à—ë–Ω'
  };
  return names[status] || status;
}

function getStepInfo(step: number): string {
  const steps: { [key: number]: string } = {
    1: 'üè¢ –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏',
    2: 'üìã –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤',
    3: 'üìÑ –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ–∫–∞',
    4: 'üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
    5: 'üè¶ –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è',
    6: 'üì® –ü–æ–ª—É—á–µ–Ω–∏–µ —á–µ–∫–∞ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
    7: '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è'
  };
  return steps[step] || `–®–∞–≥ ${step}`;
}

function getStatusExplanation(status: string): string {
  const explanations: { [key: string]: string } = {
    'draft': '–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏.',
    'in_progress': '–ü—Ä–æ–µ–∫—Ç –≤ —Ä–∞–±–æ—Ç–µ, –æ–∂–∏–¥–∞–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.',
    'waiting_approval': '–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.',
    'waiting_receipt': '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ.',
    'receipt_approved': '–ß–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤.',
    'filling_requisites': '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.',
    'waiting_manager_receipt': '–û–∂–∏–¥–∞–µ—Ç—Å—è —á–µ–∫ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞.',
    'in_work': '–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å.',
    'waiting_client_confirmation': '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤.',
    'completed': '–ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!'
  };
  return explanations[status] || '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.';
}

function getNextStepHint(status: string, currentStep: number): string {
  const hints: { [key: string]: string } = {
    'draft': 'üìù –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏',
    'in_progress': 'üìã –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é',
    'waiting_approval': '‚è≥ –û–∂–∏–¥–∞–µ–º –æ–¥–æ–±—Ä–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
    'waiting_receipt': 'üìÑ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ',
    'receipt_approved': 'üí≥ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤',
    'filling_requisites': 'üè¶ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã',
    'waiting_manager_receipt': '‚è∞ –û–∂–∏–¥–∞–µ–º —á–µ–∫ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
    'in_work': 'üîÑ –ú–µ–Ω–µ–¥–∂–µ—Ä –≥–æ—Ç–æ–≤–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã',
    'waiting_client_confirmation': '‚úã –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ',
    'completed': 'üéâ –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!'
  };
  return hints[status] || '';
}

function getSuggestions(userContext: any, context: string): string {
  const suggestions = [];
  
  if (context === 'project' && userContext.current_project) {
    suggestions.push('‚Ä¢ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞', '‚Ä¢ –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø', '‚Ä¢ –°—É–º–º–∞ –ø—Ä–æ–µ–∫—Ç–∞');
  }
  
  if (userContext.recent_projects?.length > 0) {
    suggestions.push('‚Ä¢ –ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã');
  }
  
  if (userContext.suppliers_count > 0) {
    suggestions.push('‚Ä¢ –ö–∞—Ç–∞–ª–æ–≥ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤');
  }
  
  suggestions.push('‚Ä¢ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç', '‚Ä¢ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', '‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞');
  
  return suggestions.join('\n');
} 