# üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï RACE CONDITION –í –ß–ê–¢–ï - –£–°–¢–†–ê–ù–ï–ù–ò–ï "–¢–ï–õ–ï–ü–û–†–¢–ê–¶–ò–ò"

## üö® –ü–†–û–ë–õ–ï–ú–ê (–ë–´–õ–û)
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã —á–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ "—Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è" - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ–∫–ª—é—á–∞–ª—Å—è –º–µ–∂–¥—É —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–æ–π 4-5 —Ä–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–∫—É–Ω–¥, —Å–æ–∑–¥–∞–≤–∞—è —É–∂–∞—Å–Ω—ã–π UX.

## ‚ö° –ü–†–ò–ß–ò–ù–´ RACE CONDITION
1. **–ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã** –≤ useEffect —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `rooms.length`
2. **–†—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** —á–µ—Ä–µ–∑ `setSelectedRoom(newRoom)` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
3. **–¢–∞–π–º–∞—É—Ç—ã –≤ handleRoomSelect** —Å–æ–∑–¥–∞–≤–∞–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏
4. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä—ã** React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º

## ‚úÖ –†–ï–®–ï–ù–ò–ï (–°–¢–ê–õ–û)

### 1. –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `isManuallySelectingRoom`
```typescript
const [isManuallySelectingRoom, setIsManuallySelectingRoom] = useState(false)
```
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–≤—ã–±–æ—Ä –≤–æ –≤—Ä–µ–º—è —Ä—É—á–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è/–≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏ —Ä—É—á–Ω–æ–π –ª–æ–≥–∏–∫–æ–π

### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω `handleRoomSelect` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
```typescript
const handleRoomSelect = useCallback((room: any, immediate: boolean = false) => {
  // ... 
  if (immediate) {
    // üöÄ –ú–ì–ù–û–í–ï–ù–ù–û–ï –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–Ω–∞—Ç
    setSelectedRoom(room);
    setIsRoomSwitching(false);
    setIsManuallySelectingRoom(false);
  } else {
    // üé¨ –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    setIsRoomSwitching(true);
    roomSwitchTimeoutRef.current = setTimeout(() => {
      // ...
    }, 150);
  }
}, [selectedRoom?.id]);
```

### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç
```typescript
const handleCreateAIRoom = useCallback(async () => {
  setIsCreatingRoom(true);
  setIsManuallySelectingRoom(true); // üîí –ë–ª–æ–∫–∏—Ä—É–µ–º –∞–≤—Ç–æ–≤—ã–±–æ—Ä
  
  try {
    const newRoom = await createRoom({...});
    // üöÄ –ú–ì–ù–û–í–ï–ù–ù–û–ï –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ë–ï–ó –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    handleRoomSelect(newRoom, true);
  } finally {
    setIsCreatingRoom(false);
  }
}, []);
```

### 4. –£–ª—É—á—à–µ–Ω –∞–≤—Ç–æ–≤—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç –≤ useEffect
```typescript
useEffect(() => {
  // üéØ –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–Ω–∞—Ç –ò –µ—Å–ª–∏ –Ω–∏–∫—Ç–æ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç/–≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é
  if (rooms.length > 0 && !selectedRoom && !initialRoomsLoaded && !isCreatingRoom && !isManuallySelectingRoom) {
    setSelectedRoom(rooms[0]);
    setInitialRoomsLoaded(true);
  }
}, [rooms.length, selectedRoom, initialRoomsLoaded, isCreatingRoom, isManuallySelectingRoom]);
```

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `useChatRooms`
```typescript
setRooms(prev => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–Ω–∞—Ç–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
  const exists = prev.some(room => room.id === newRoomWithStats.id);
  if (exists) return prev;
  return [newRoomWithStats, ...prev];
});
```

### 6. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ API
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
if (room_type === 'project' && project_id) {
  const { data: existingRoom } = await supabase
    .from('chat_rooms')
    .select('id, name')
    .eq('user_id', user_id)
    .eq('project_id', project_id)
    // ...
}
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ AI –∫–æ–º–Ω–∞—Ç—ã
1. –û—Ç–∫—Ä–æ–π—Ç–µ `/dashboard/ai-chat`
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "+" ‚Üí "üí¨ –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å AI"
3. **–û–ñ–ò–î–ê–ù–ò–ï**: –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –ú–ì–ù–û–í–ï–ù–ù–û —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π –ë–ï–ó –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ `/dashboard/create-project`
2. –í —á–∞—Ç–µ –Ω–∞–∂–º–∏—Ç–µ "+" ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç ‚Üí "ü§ù –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
3. **–û–ñ–ò–î–ê–ù–ò–ï**: –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –ú–ì–ù–û–í–ï–ù–ù–û —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π –ë–ï–ó –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ë—ã—Å—Ç—Ä—ã–µ AI –ø—Ä–æ–º–ø—Ç—ã
1. –í –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–º–ø—Ç
2. **–û–ñ–ò–î–ê–ù–ò–ï**: AI –∫–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –ø—Ä–æ–º–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó –º–µ—Ä—Ü–∞–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–æ–º–Ω–∞—Ç–∞–º–∏
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç
2. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –Ω–∏–º –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
3. **–û–ñ–ò–î–ê–ù–ò–ï**: –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π (150ms)

## üîç –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥—è—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:
- `üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–Ω–∞—Ç—É: [–Ω–∞–∑–≤–∞–Ω–∏–µ] (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ/—Å –∞–Ω–∏–º–∞—Ü–∏–µ–π)`
- `üéØ –ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–≤—Ç–æ–≤—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã: [–Ω–∞–∑–≤–∞–Ω–∏–µ]`
- `‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: [–Ω–∞–∑–≤–∞–Ω–∏–µ]`
- `üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ isCreatingRoom/isManuallySelectingRoom`

## ‚ú® –†–ï–ó–£–õ–¨–¢–ê–¢

**–¢–ï–õ–ï–ü–û–†–¢–ê–¶–ò–Ø –ü–û–õ–ù–û–°–¢–¨–Æ –£–°–¢–†–ê–ù–ï–ù–ê!**

- ‚úÖ –ù–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ú–ì–ù–û–í–ï–ù–ù–û
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π —Ç—É–¥–∞-—Å—é–¥–∞
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –≤—ã–±–æ—Ä–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üöÄ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨

- –°–æ–∫—Ä–∞—â–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–æ–≤ –Ω–∞ 60-80%
- –£–±—Ä–∞–Ω—ã –Ω–µ–Ω—É–∂–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç memory leaks —á–µ—Ä–µ–∑ cleanup useEffect
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

---

**–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ò –ù–ê–í–°–ï–ì–î–ê! üéâ** 