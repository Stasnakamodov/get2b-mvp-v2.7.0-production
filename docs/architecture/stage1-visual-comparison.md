# STAGE 1: КАК ЕСТЬ vs КАК ДОЛЖНО БЫТЬ

## 🔴 КАК ЕСТЬ СЕЙЧАС (БЕСПОРЯДОК)

```
┌─────────────────────────────────────────────────────────────────┐
│                    МОНОЛИТ page.tsx (4918 строк)                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │              STAGE 1 UI (1673 строки)                      ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Action Buttons (49 строк)                            │ ││
│  │  │ ├─ Удалить данные                                     │ ││
│  │  │ ├─ Посмотреть все данные                             │ ││
│  │  │ └─ Добавить товары                                   │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Step Header (13 строк)                               │ ││
│  │  │ - номер и название шага                              │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Template Selection (122 строки) 🔴 390% беспорядка   │ ││
│  │  │ ├─ Список шаблонов                                    │ ││
│  │  │ ├─ Debug кнопки (создать таблицу, анализ БД)         │ ││
│  │  │ ├─ Empty state                                        │ ││
│  │  │ └─ Индикатор загрузки                                │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Manual Forms (78 строк) 🟠 234% беспорядка           │ ││
│  │  │ if (шаг 1 && тип company) → CompanyForm              │ ││
│  │  │ if (шаг 1 && тип contacts) → ContactsForm            │ ││
│  │  │ if (шаг 1 && тип bank) → BankForm                    │ ││
│  │  │ if (шаг 2) → SpecificationForm                       │ ││
│  │  │ if (шаг 3) → FileUploadForm                          │ ││
│  │  │ if (шаг 4) → PaymentMethodForm                       │ ││
│  │  │ if (шаг 5) → RequisitesForm                          │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ OCR Upload (239 строк) 🔴 766% беспорядка            │ ││
│  │  │ ├─ Drag & Drop зона                                  │ ││
│  │  │ ├─ Статусы: analyzing, success, error                │ ││
│  │  │ ├─ Отладочная информация                             │ ││
│  │  │ └─ Блок загрузки чека (шаг 7)                        │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Step 1 Data Cubes (71 строка)                        │ ││
│  │  │ ├─ Данные компании (синий)                           │ ││
│  │  │ ├─ Расчетный счет (зеленый)                          │ ││
│  │  │ └─ Контакты (фиолетовый)                             │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Step 2 Product Slider (158 строк) 🔴 379% беспорядка │ ││
│  │  │ ├─ Кнопки навигации                                  │ ││
│  │  │ ├─ Сетка товаров (3 колонки)                         │ ││
│  │  │ ├─ Точки-индикаторы                                  │ ││
│  │  │ └─ Сводная информация                                │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Step 4 Payment Cubes (124 строки) 🔴 744% беспорядка │ ││
│  │  │ ├─ bank-transfer кубик                               │ ││
│  │  │ ├─ p2p кубик                                         │ ││
│  │  │ ├─ crypto кубик                                      │ ││
│  │  │ └─ Сложная проверка доступности (12 зависимостей)   │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Step 5 Requisites Cubes (337 строк) 🔴🔴🔴           │ ││
│  │  │             2527% БЕСПОРЯДКА - КАТАСТРОФА            │ ││
│  │  │                                                       │ ││
│  │  │ ├─ if (заполнены) → показать кубики с данными        │ ││
│  │  │ ├─ if (catalog) → кубики выбора типа                 │ ││
│  │  │ ├─ Двусторонняя синхронизация с шагом 4 ⚠️          │ ││
│  │  │ ├─ Проверка доступности методов                      │ ││
│  │  │ ├─ Multiple/Single режимы                            │ ││
│  │  │ └─ 15 зависимостей от других функций                 │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  │                                                             ││
│  │  ┌──────────────────────────────────────────────────────┐ ││
│  │  │ Source Selection Cards (229 строк) 🟠 229% беспорядка│ ││
│  │  │ ├─ profile                                            │ ││
│  │  │ ├─ template                                           │ ││
│  │  │ ├─ catalog                                            │ ││
│  │  │ ├─ manual                                             │ ││
│  │  │ └─ upload                                             │ ││
│  │  └──────────────────────────────────────────────────────┘ ││
│  └─────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌────────────────────────────────────────────────────────────┐│
│  │              ОБРАБОТЧИКИ (17 функций)                     ││
│  │                                                             ││
│  │  handleSourceSelect (103 строки) 🔴 772% беспорядка        ││
│  │  ├─ if (profile) → загрузить профиль                       ││
│  │  ├─ if (template) → показать шаблоны                       ││
│  │  ├─ if (catalog) → открыть каталог                         ││
│  │  ├─ if (upload) → открыть форму загрузки                   ││
│  │  ├─ if (manual) → открыть ручные формы                     ││
│  │  └─ 15 зависимостей                                        ││
│  │                                                             ││
│  │  handleCatalogProductsAdd (188 строк) 🔴🔴 1880% беспорядка││
│  │  ├─ Преобразование данных каталога                         ││
│  │  ├─ Автозаполнение шага 2 (товары)                         ││
│  │  ├─ Автозаполнение шага 4 (способ оплаты)                  ││
│  │  ├─ Автозаполнение шага 5 (реквизиты)                      ││
│  │  ├─ Приоритетная логика каталога                           ││
│  │  └─ 20 зависимостей                                        ││
│  │                                                             ││
│  │  handleSelectBlueRoomSupplier (131 строка) 🔴 982% беспоряд││
│  │  ├─ Заполнение шага 2 (товары)                             ││
│  │  ├─ Заполнение шага 4 (способ оплаты)                      ││
│  │  ├─ Заполнение шага 5 (реквизиты)                          ││
│  │  └─ 15 зависимостей                                        ││
│  │                                                             ││
│  │  handleSelectOrangeRoomSupplier (114 строк) 🔴 855% беспоря││
│  │  ├─ Дублирует логику BlueRoom                              ││
│  │  ├─ Заполнение 3 шагов                                     ││
│  │  └─ 15 зависимостей                                        ││
│  │                                                             ││
│  │  analyzeSpecification (133 строки) 🔴 798% беспорядка      ││
│  │  ├─ OCR анализ инвойса                                     ││
│  │  ├─ Извлечение реквизитов                                  ││
│  │  ├─ Автозаполнение шагов 4 и 5                             ││
│  │  └─ 12 зависимостей                                        ││
│  │                                                             ││
│  │  handleManualDataSave (74 строки) 🔴 355% беспорядка       ││
│  │  ├─ Валидация                                              ││
│  │  ├─ Слияние данных                                         ││
│  │  ├─ Автозаполнение связанных шагов                         ││
│  │  ├─ Проверка готовности                                    ││
│  │  └─ 12 зависимостей                                        ││
│  │                                                             ││
│  │  + еще 11 обработчиков...                                  ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              СОСТОЯНИЯ (35 useState)                       │ │
│  │                                                             │ │
│  │  stepConfigs, manualData, lastHoveredStep, hoveredStep,    │ │
│  │  selectedSource, templateSelection, templateStepSelection,  │ │
│  │  templateError, templateLoading, ocrAnalyzing, ocrError,    │ │
│  │  ocrDebugData, uploadedFiles, previewData, previewType,     │ │
│  │  editingType, showCatalogModal, showCatalogSourceModal,     │ │
│  │  catalogSourceStep, blueRoomSuppliers, blueRoomLoading,     │ │
│  │  orangeRoomSuppliers, orangeRoomLoading, selectedSupplier,  │ │
│  │  currentProductIndex, currentItemIndex, autoFillNotification│ │
│  │  selectedProfileId, selectedSupplierProfileId, currentStage,│ │
│  │  dontShowStageTransition, stageTransitionShown, user, ...   │ │
│  └─────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘

ПРОБЛЕМЫ:
❌ Все в одном файле (4918 строк)
❌ UI смешан с бизнес-логикой
❌ 35 разрозненных состояний
❌ Функции делают по 5 вещей одновременно
❌ Дублирование кода (blue/orange room)
❌ Двусторонняя связь между шагами 4↔5
❌ Нет переиспользования компонентов
```

---

## ✅ КАК ДОЛЖНО БЫТЬ (ПОРЯДОК)

```
┌─────────────────────────────────────────────────────────────────┐
│                    page.tsx (ТОЛЬКО КООРДИНАЦИЯ)                │
│                                                                  │
│  const { stepData, updateStep } = useStepData()                 │
│  const { uploadFile, analyzeOcr } = useOcrUpload()              │
│  const { selectSupplier } = useCatalogIntegration()             │
│  const { templates, applyTemplate } = useTemplates()            │
│                                                                  │
│  return (                                                        │
│    <StageRouter currentStage={currentStage}>                    │
│      <Stage1Container                                           │
│        stepData={stepData}                                      │
│        onStepUpdate={updateStep}                                │
│        onUpload={uploadFile}                                    │
│        onCatalogSelect={selectSupplier}                         │
│      />                                                          │
│    </StageRouter>                                               │
│  )                                                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│           Stage1Container.tsx (КООРДИНАЦИЯ UI)                  │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  StepHeader (отдельный компонент)                      │    │
│  │  - Номер шага                                          │    │
│  │  - Название                                            │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  ActionButtons (отдельный компонент)                   │    │
│  │  - Удалить                                             │    │
│  │  - Посмотреть                                          │    │
│  │  - Добавить товары                                     │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
│  {mode === 'template' && <TemplateSelector />}                  │
│  {mode === 'manual' && <ManualForms />}                         │
│  {mode === 'ocr' && <OcrUploadForm />}                          │
│  {mode === 'source' && <SourceSelector />}                      │
│                                                                  │
│  <StepDataDisplay step={currentStep} data={stepData} />         │
└──────────────────────────────────────────────────────────────────┘
          ↓              ↓              ↓              ↓
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Template    │  │   Manual    │  │     OCR     │  │   Source    │
│  Selector   │  │   Forms     │  │   Upload    │  │  Selector   │
│             │  │             │  │             │  │             │
│ - Список    │  │ - Company   │  │ - DragDrop  │  │ - Profile   │
│ - Выбор     │  │ - Contacts  │  │ - Status    │  │ - Template  │
│ - Применить │  │ - Bank      │  │ - Preview   │  │ - Catalog   │
│             │  │ - Spec      │  │ - Debug     │  │ - Manual    │
│             │  │ - Payment   │  │             │  │ - Upload    │
│             │  │ - Requisites│  │             │  │             │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              ОТОБРАЖЕНИЕ ДАННЫХ (ПО ШАГАМ)                      │
│                                                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐│
│  │  Step1Data │  │  Step2Data │  │  Step4Data │  │  Step5Data ││
│  │   Cubes    │  │   Slider   │  │   Cubes    │  │   Cubes    ││
│  │            │  │            │  │            │  │            ││
│  │ - Компания │  │ - Товары   │  │ - Bank     │  │ - Bank     ││
│  │ - Счет     │  │ - Слайдер  │  │ - P2P      │  │ - P2P      ││
│  │ - Контакты │  │ - Навигация│  │ - Crypto   │  │ - Crypto   ││
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘│
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  БИЗНЕС-ЛОГИКА (ХУКИ)                           │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useStepData()  📦 ЦЕНТРАЛЬНОЕ ХРАНИЛИЩЕ                │   │
│  │  ├─ stepConfigs: Record<number, StepConfig>             │   │
│  │  ├─ manualData: Record<number, any>                     │   │
│  │  ├─ updateStep(stepId, data)                            │   │
│  │  ├─ removeStep(stepId)                                  │   │
│  │  └─ validateStep(stepId)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useOcrUpload()  📤 OCR ЗАГРУЗКА И АНАЛИЗ               │   │
│  │  ├─ uploadFile(file, stepId)                            │   │
│  │  ├─ analyzeDocument(url, type)                          │   │
│  │  ├─ ocrState: { analyzing, error, debug }               │   │
│  │  └─ cancelUpload(stepId)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useCatalogIntegration()  🏪 КАТАЛОГ                     │   │
│  │  ├─ selectSupplier(supplier, room: 'blue'|'orange')     │   │
│  │  ├─ addProducts(products)                               │   │
│  │  ├─ fillPaymentAndRequisites(supplier)  ← ОДИН МЕТОД   │   │
│  │  └─ catalogState: { loading, suppliers }                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useTemplates()  📋 ШАБЛОНЫ                             │   │
│  │  ├─ templates: Template[]                               │   │
│  │  ├─ applyTemplate(templateId)                           │   │
│  │  ├─ applyTemplateStep(templateId, stepId)               │   │
│  │  └─ fillAllSteps(templateId)                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useStep4Step5Sync()  🔗 СИНХРОНИЗАЦИЯ 4↔5              │   │
│  │  ├─ syncPaymentToRequisites(method)                     │   │
│  │  ├─ syncRequisitesToPayment(requisites)                 │   │
│  │  └─ checkAvailability(method, supplier)                 │   │
│  └─────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  УТИЛИТЫ (ЧИСТЫЕ ФУНКЦИИ)                       │
│                                                                  │
│  transformCatalogProducts(products) → Step2Data                 │
│  transformSupplierToSteps(supplier) → { step2, step4, step5 }   │
│  extractBankRequisites(text) → BankRequisites                   │
│  checkMethodAvailability(method, supplier) → boolean            │
│  validateStepData(stepId, data) → ValidationResult              │
└──────────────────────────────────────────────────────────────────┘

ПРЕИМУЩЕСТВА:
✅ Разделение ответственности (UI / Logic / Data)
✅ Переиспользуемые компоненты
✅ Один хук = одна ответственность
✅ Чистые функции для преобразований
✅ Централизованное состояние через useStepData
✅ Нет дублирования (blue/orange → один метод)
✅ Понятная синхронизация (useStep4Step5Sync)
✅ Легко тестировать
✅ Легко добавлять новые источники
```

---

## 📊 СРАВНЕНИЕ В ЦИФРАХ

| Метрика | КАК ЕСТЬ 🔴 | КАК ДОЛЖНО БЫТЬ ✅ | Улучшение |
|---------|-------------|-------------------|-----------|
| **Размер page.tsx** | 4918 строк | ~200 строк | **-96%** |
| **UI компонентов** | 13 блоков в монолите | 10 отдельных файлов | Модульность |
| **Обработчиков** | 17 функций (2000+ строк) | 5 хуков (~500 строк) | **-75%** |
| **Состояний** | 35 useState | 5 контекстов | **-86%** |
| **Дублирование** | blue/orange (245 строк) | 1 функция (80 строк) | **-67%** |
| **Связанность** | Все связано со всем | Слои изолированы | ⭐⭐⭐ |
| **Тестируемость** | Невозможно | Легко | ⭐⭐⭐ |
| **Поддержка** | Кошмар | Просто | ⭐⭐⭐ |

---

## 🎯 КЛЮЧЕВЫЕ ОТЛИЧИЯ

### КАК ЕСТЬ (ПРОБЛЕМЫ):
1. **337 строк** для Step 5 Requisites - ВСЁ В ОДНОМ МЕСТЕ
2. **188 строк** handleCatalogProductsAdd - ДЕЛАЕТ 5 ВЕЩЕЙ
3. **Blue/Orange** handlers - ДУБЛИРУЮТ КОД
4. **35 useState** - РАЗБРОСАНЫ ВЕЗДЕ
5. **UI + Logic** - СМЕШАНО В ОДНОМ ФАЙЛЕ

### КАК ДОЛЖНО БЫТЬ (РЕШЕНИЯ):
1. **Step5RequisitesCubes** компонент + **useRequisitesAvailability** хук
2. **useCatalogIntegration** хук - ОДНА ОТВЕТСТВЕННОСТЬ
3. **selectSupplier(supplier, room)** - ОДИН МЕТОД ДЛЯ ОБОИХ
4. **5 контекстов** - ОРГАНИЗОВАННОЕ СОСТОЯНИЕ
5. **Presentation ← Logic ← Data** - ЧЁТКИЕ СЛОИ

---

## 🚀 ЧТО ДЕЛАТЬ ДАЛЬШЕ?

### ФАЗА 1: Хуки (1 неделя)
```
1. Создать useStepData() - центральное хранилище
2. Создать useOcrUpload() - вся OCR логика
3. Создать useCatalogIntegration() - каталог в один хук
4. Создать useStep4Step5Sync() - синхронизация
5. Создать useTemplates() - работа с шаблонами
```

### ФАЗА 2: Компоненты (1 неделя)
```
1. Вынести Step5RequisitesCubes
2. Вынести Step4PaymentCubes
3. Вынести Step2ProductSlider
4. Вынести OcrUploadForm
5. Вынести TemplateSelector
```

### ФАЗА 3: Утилиты (3 дня)
```
1. transformCatalogProducts()
2. transformSupplierToSteps()
3. extractBankRequisites()
4. checkMethodAvailability()
5. validateStepData()
```

**ИТОГО: 2-3 недели** → Из хаоса в порядок! 🎉
